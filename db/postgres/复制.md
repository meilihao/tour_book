# 复制
PostgreSQL支持物理复制(即流复制)及逻辑复制(即选择性复制)2种:
- 通过流复制技术，可以从**实例级**复制出一个与主库一模一样的实例级的从库, 流复制同步方式有同步、异步两种. 如果主/备库均不是很忙时, 通常异步复制延迟能控制在毫秒级.
- 逻辑复制，区别于物理复制的是**物理复制是基于实例级的复制，只能复制整个PostgreSQL实例，而不能基于部分库及表**. 从PostgreSQL10开始，出现了基于表级别的复制，即逻辑复制.

区别:
1. 流复制和逻辑复制均基于wal, 但本质不同: 流复制基于wal物理复制, 逻辑复制基于wal逻辑解析.
1. 流复制会复制DDL操作, 而逻辑复制不会
1. 流复制备库不能写, 但逻辑复制的备库可读写
1. 流复制要求pg大版本一致, 逻辑复制可跨大版本

## 数据库复制
数据库复制将数据复制到其他服务器上，并将其存储在多个节点上。在此过程中，数据库实例从一个节点转移到另一节点，并进行了精确的复制。数据复制用于提高数据可用性，这是HA的一项关键功能。通常有一个完整的数据库实例，或者一些经常使用或所需的对象被复制到另一台服务器。复制提供了数据库的多个一致副本，它不仅提供了高可用性，而且还提高了查询性能.

### 同步复制
将数据写入磁盘时，有两种策略：“同步”和“异步”。同步复制意味着同时将数据写入主服务器和从服务器，换句话说，“同步复制”意味着提交等待远程端的写入/刷新。同步复制用于具有即时故障转移要求的高端事务环境中.

pg同步流复制在主库上提交事务时需等待备库接收并写入WAL日志, 当主库至少收到一个备库发回的确认信息时便返回成功. 同步流复制确保了至少一个备库收到了主库发送的 WAL日志，一方面保障了数据的完整性，另一方面增加了事务响应时间，因此同步流复制主库的吞吐量相比异步流复主库吞吐量低.

### 异步复制
异步意味着首先将数据写入主机，然后再复制到从机。在崩溃的情况下，可能会发生数据丢失，但是异步复制提供的开销很小，因此在大多数情况下是可以接受的。它不会使主机负担过重。与同步复制相比，从主数据库到从数据库的故障转移需要更长的时间.
简而言之，同步和异步之间的主要区别在于何时将数据写入主服务器和从服务器

pg异步流复制指主库上提交事务时不需要等待备库接收写入 WAL 日志时便返回成功，如果主库异常宕机, 主库上已提交的事务可能还没来得及发送给备库，就会造成备库数据丢失, 备库丢失的数据量和WAL复制延迟有关, WAL复制延迟越大, 备库上丢失的数据量越大.

## 配置
参考:
- [Postgresql12主从配置及切换](https://blog.csdn.net/luxingjyp/article/details/104647447)
- [PostgreSQL主从流复制与手动主备切换架构](https://blog.csdn.net/Linuxprobe18/article/details/102454221)