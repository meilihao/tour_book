# 秒杀
## 减库存
1. 下单减库存. 下单减库存是最简单的减库存方式，也是控制最精确的一种，下单时直接通过数据库的事务机制控制商品库存，这样一定不会出现超卖的情况. 但恶意/没购买意愿下单的人是不会真正付款的, 却占用库存, 导致其他用户无法购买.

1. 付款减库存. 因为付款时才减库存，如果并发比较高，有可能出现买家下单后付不了款的情况，因为可能商品已经被其他人买走了, 用户体验差.

1. 预扣库存(**主流, 推荐**). 买家下单扣库存后，库存为其保留一定的付款时间（如30分钟），超过这个时间，库存将会自动释放，释放后其他买家就可以继续购买.

针对少量商品可用redis list的`pop`来实现.

## 秒杀
秒杀中并不需要对库存有精确的一致性读，把库存数据放到缓存（Cache）中，可以大大提升读性能.

要解决并发锁的问题，有两种办法：
- 应用层做排队(mq). 按照商品维度设置队列顺序执行，这样能限制对数据库同一行记录进行操作的并发度，同时也能控制单个商品占用数据库连接的数量，防止热点商品占用太多的数据库连接.
- 数据库层做排队. 应用层只能做到单机的排队，但是应用机器数本身很多，这种排队方式控制并发的能力仍然有限，所以如果能在数据库层做全局排队是最理想的. 阿里的数据库团队开发了针对这种MySQL的InnoDB层上的补丁程序（patch），可以在数据库层上对单行记录做到并发排队.