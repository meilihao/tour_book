# IEC104
ref:
- [**IEC104/IEC101初学者教程**](https://blog.redisant.cn/docs/iec104-tutorial/)
- [**详解IEC104 规约【最详细版】**](https://blog.csdn.net/changqing1990/article/details/134327980)
- [IEC60870-5-104](https://docs.emqx.com/zh/neuron/v2.8/configuration/south-devices/iec-104/iec-104.html)
- [IEC104电力规约介绍及常见模拟器](https://www.claves.cn/archives/8761)
- [**智能变电站协议系列-5、IEC 104协议细化解读（IEC 60870以及如何获取对应国标和行标）**](https://blog.csdn.net/weixin_39510813/article/details/137479398)

    有部分代码
- [**IEC104规约介绍**](https://www.bilibili.com/video/BV1Gm411f7bS)
- [2022-12-17_02-06-31 IEC104总召唤及电度量要求](https://www.bilibili.com/video/BV1zg411E7Mr) 

[IEC60870-5-104](https://sgool.zju.edu.cn/solutions/LCC/LCC_IN_ACTION/book/files/IEC60870-5-104%E8%A7%84%E7%BA%A6.pdf) 是一种实现电力系统自动化设备间数据交换的标准, 由国际电工委员会(IEC)制定，使用 TCP/IP 协议作为底层通信协议，用于监视和控制电力系统中的各种设备.

IEC 104由于其高效的通信方式和对实时性、可靠性的支持，已经成为电力行业和能源管理中非常重要的通信标准.

版本:
1. 1995 : 正式发布
1. 2002 : IEC 60870-5-104:2002
1. 2009 : IEC 60870-5-104:2009

    [国家能源局 - 电力行业标准列表（DL）](https://www.nea.gov.cn/2017-05/26/c_136317239.htm)使用2009版本.
1. 2019 : IEC GUIDE 104:2019

[与IEC101间的主要关系](https://www.bilibili.com/video/BV1hucJeaExA):
1. **IEC104是IEC101在应用层协议上的扩展**
1. IEC101使用串口(RS-232/RS485)通信, IEC104使用网络通信
1. IEC101一般采用非平衡传输模式, IEC104一般采用平衡传输模式

与Modbus相比: IEC 104更适合电力系统自动化的应用，尤其是在有时间戳、事件处理等复杂需求的场景，而Modbus常用于工业自动化中的设备间通信，支持的功能相对简单

## 术语
1. 遥脉（电度量）：是指对现场某装置所发出的脉冲信号进行周期累计的一种远程计数操作。及遥脉一词的。

1. 单点与双点的区别，以遥信为例，单点就是用一位标识一个遥信量，比如开关位置，只采集一个常开的辅助接点，值为1表示合位，0表示分位；而双点需要采集常开和常闭两个辅助接点位置，当常开点值为1并且常闭点值为0，即10，则认为开关在合位；当常开点值=0并且常闭点值为1，即01，认为开关在分位；当两个位置值都为1，或两个值都为0，则认为开关位置不能确定。遥控也是一样的道理，SPI为遥信状态值。单点遥信，0分1合；双点遥信，1开2合，0和3为中间状态。

1. 遥测的上送方式主要有定时主动上送（01H），响应总召唤上送（14H），越限上送（03H），而遥测值又分为归一化值、标度化值、短浮点数。

    各遥测报文。其报文主体结构未变，改变是传送原因及类型标识。

1. 归一化值（NVA）

    值的范围为[-1，1]。归一化，即是将大于1的数映射到1以内的空间，通常就是用实际值除以额定值，即得到归一化的小数. 占2个字节。

1. 标度化值（SVA），值的范围为[-32768，~32767]，即带符号整数。占２个字节。它的真实值就是标度值*小数点的位数，量程和小数点位置是固定的参数。（相当于16位有符号整数）

1. 短浮点数（R32-IEEE STD 754） 即计算机内浮点数的表示法，占４字节

1. 双传输，信息体元素可以用同一个信息对象地址来构成不同的ASDU，即带时标或者不带时标的单点信息。

注意：归一化值与标度化值都是两个字节。高字节的最高位为符号位， 0表示正数，1表示负数。15位数据位，正数是原码，负数是补码。

1. 绝对时标: CP56Time2a格式, 用于标识和同步不同设备之间的时间, 时标的格式通常为年, 月, 日, 时, 分, 秒和毫秒.

    ![CP56Time2a](/misc/img/develop/iot/CP56Time2a.png)

1. 四遥指的是：遥信、遥测、遥控和遥调（设点）；分别对应数字输入DI、模拟输入AI、数字输出DO和模拟输出AO

    > 遥脉可以看成是被具体规定了采用脉冲计数作为测量方法的一种遥测手段，它是遥测中的一种.

    | 类型  | 信息体基地址范围| 信息体地址个数        |
    |-------|-------------------------------|-----------|
    |遥信|0x0001-0x4000|16384|
    |遥测|0x4001-0x5000|4096|
    |遥控|0x6001-0x6100|256|
    |遥调(设点)|0x6201-0x6400|512|
    |遥脉(电度)|0x6401-0x6600|512|

    - 遥信：用于表示离散的数字量输入（如开关状态、继电器状态等），通常用于传输二进制状态信息

        - M_SP_NA_1 (Type ID: 1)	单点信息（如断路器合/分）
        - M_SP_TA_1 (Type ID: 2)	带时标的单点信息
        - M_DP_NA_1 (Type ID: 3)	双点信息（如刀闸开/合/中间）
        - M_DP_TA_1 (Type ID: 4)	带时标的双点信息
        - M_ST_NA_1 (Type ID: 5)	步位置信息（如分接头位置）
        - M_ST_TA_1 (Type ID: 6)	带时标的步位置信息
    - 遥测：用于表示连续的模拟量输入（如电压、电流、温度等），通常用于传输传感器测量值或过程变量

        - M_ME_NA_1 (Type ID: 9)	测量值，归一化值
        - M_ME_TA_1 (Type ID: 10)	带时标的测量值，归一化值
        - M_ME_NB_1 (Type ID: 11)	测量值，标度化值
        - M_ME_TB_1 (Type ID: 12)	带时标的测量值，标度化值
        - M_ME_NC_1 (Type ID: 13)	测量值，短浮点数
        - M_ME_TC_1 (Type ID: 14)	带时标的测量值，短浮点数
        - M_IT_NA_1 (Type ID: 15)	累积量（计数量，如电度），不带时标
        - M_IT_TA_1 (Type ID: 16)	带时标的累积量（计数量）
    - 遥调: 通常指对设备的模拟量设定值进行修改的命令，例如设定发电机的出力值、电压参考值等

        - C_SE_NA_1 (Type ID: 48)	设定值命令，归一化值
        - C_SE_NB_1 (Type ID: 49)	设定值命令，标度化值
        - C_SE_NC_1 (Type ID: 50)	设定值命令，短浮点数
    - 遥控：用于发送控制命令到远程设备（如开关控制、继电器操作等），通常用于执行远程控制操作

        - C_SC_NA_1 (Type ID: 45)	单命令（如断路器合/分）
        - C_DC_NA_1 (Type ID: 46)	双命令（如刀闸开/合）
        - C_RC_NA_1 (Type ID: 47)	调节步命令（如步进升/降）
    - 遥脉: 通常指的是脉冲计数或累积量，例如电能表输出的脉冲、流量计的累积量等

        - M_IT_NA_1 (Type ID: 15)	累积量，不带时标
        - M_IT_TA_1 (Type ID: 16)	带时标的累积量

## 组成
IEC104 协议是基于TCP的应用层协议, 其架构为client/Server 模式:
- TCP Server 负责和实际的硬件控制，数据采集，命令执行等功能，因此也叫受控制站(分站/子站)， IEC101 中还被叫做Slave

    固定端口2404
- TCP Client 负责远程控制，获取server采集的数据，配置server等，因此也叫控制站(或主站)，IEC101 中还被叫做Master

![](/misc/img/develop/iot/d0ccfd20399709e85cebdb96c4eab821.png)

![网络结构](/misc/img/develop/iot/iec104.topology.png)

## 传输模式
IEC104 支持两种传输模式:
1. 非平衡传输模式

    在该模式下，只有控制站（client）才能启动一次消息传输，受控站（server） 只能响应控制站（client）的请求。在这种模式下，控制站（client）通过依次轮询 所控制的 受控站（server）来获取对应的业务数据.

1. 平衡传输模式, **最常用**

    每个站（client和server）都可以启动消息传输

## 基础功能
1. 数据采集

    iec104 协议中，所有的数据都被缓存在受控站中（Server），因为数据产生的速度可能会比传输的速度更快.

    - 在非平衡传输的链路模式下，受控站（Server）总是等待控制站发送的数据polling请求，并给以回应
    - 在平衡传输的链路模式下，受控站（Server）既可以回应 控制站 的各种请求， 也可以当数据产生变化时，或者周期性上报对象值时，主动将对应的数据传输给控制站(client)
    
        现总结该模式下受控站（Server）的数据采集行为如下：
        1. 当数据对像的值产生改变时，受控站（Server）主动上报其产生的数据；
        1. 当周期性上报数据时，受控站（Server）主动上报其产生的数据；
        1. 回应控制站(client)的控制命令，如总召唤等；
        1. 回应读请求

1. 事件采集

    受控站（Server）的应用层级事件会自动发生。其在平衡传输模式和非平衡模式下采集方式和数据采集完全相同.

1. 召唤（Interrogation）

    当一个控制站初始化后，或者控制站探测到相应信息有丢失，控制站（client) 就需要发送召唤命令，去请求受控站（Server）发送其 【所有】过程变量 的实际值.
    控制站（client)可以在仍何时候发送召唤命令，以同步受控站（Server）中的所有过程变量的值. 召唤命令分为总召唤和群组召唤:
    - 总召唤/general interrogation (GI)

        总召唤命令会请求受控站（Server）中所有群组的所有数据对象的值的更新给控制站。
    - 群组召唤

        在受控站（Server）端，数据对象可以通过配置COT的值为20～36来设定数据对象的召唤群组。20代表总召唤，21～36 分别对应INRO1～INRO16，分别对应16个召唤群组. 控制站（client) 在召唤时，可以通过指定召唤群组，来让该召唤组中的数据对象值更新.

1. 时钟同步

    受控站（Server）和 控制站（client)必须保证时钟同步，这样才能传输给控制站的数据和事件拥有保证精确的时标.

    系统初始化完成后，控制站（client)应该应当发送一次一次时钟同步指令， 此后，通过发送时钟同步命令（C_CS ACT）来周期性地重新同步时钟.

1. 命令传输（遥控）

    命令（也被称作遥控）是 控制站（client) 用来改变受控站（Server）操作设备的状态的API. 一个命令可以由操作员发起，也可以由控制台中的自动监控程序发起.
    
    命令（遥控）分为直控命令（单步命令）和选控命令：
    - 直控命令（Single command）

        直控命令实际上就是去掉选择命令，直接发执行命令。一般来说保护压板、保护复归为直控；
        直控的一般流程如下: 主站下发执行命令→装置回执行确认报文.

    - 选控命令（Select and execute）

        和直控命令（Single command）相比，该命令包含两个执行过程：
        1. Select 阶段：
            控制站发送一个该命令的Select的操作，受控站会检查该命令该命令是否正确，确认该命令是否已经有正确的执行操作。并把结论返回给控制站。
        1. execute阶段
            Select 返回预期时，执行命令。执行完成后， 装置回执行确认报文
1. 累计量传输

    累计量是一个值在指定时间内的积分值。累计量的连续采集时间间隔和Clock 是系统参数。有两种方法获取累计值的计数器信息：

    1. Freeze-and-Read: 累计量采集
    1. Clear-and-Read: 增量信息的采集

        控制站（client) 可以根据需要，使用计数器召唤命令（counter interrogation） 获取累计量计数器对象的值。累计量也可以被配成，当计数器冻结操作（counter freeze operations）发生时，主动上报其计数值。

1. 协议和链路参数的更改

    当协议和链路参数的值发生更改时，新值在提交后生效

1. 传输延迟的采集

    时间校正值由传输延迟和内部设备延迟之和确定，传输延迟是可以通过参数化单独获取的值，或者通过控制站启动一个时间校准进程来实现的

## 传输
ref:
- [**IEC104规约**](https://www.cnblogs.com/aoe1231/p/16704947.html)
- [智能变电站协议系列-4、IEC 101、IEC 104协议（IEC 60870）](https://blog.csdn.net/weixin_39510813/article/details/135213240)
- [快速了解电力IEC104协议规约](https://zhuanlan.zhihu.com/p/662034223)

字节序: 小端

### 通信方向
IEC 101/104 定义了几种方向模式：
- 监控方向是从受控站（slave）到控制站（master）的传输方向
- 控制方向是从控制站（master）到受控站（slave）的传输方向

### 传输流程
ref:
- [IEC104电力规约介绍及常见模拟器](https://www.claves.cn/archives/8761)

example:
![](/misc/img/develop/iot/iec104-tran1.png)
![](/misc/img/develop/iot/iec104-tran2.png)

### 帧结构
iec104 基于TCP/IP 传输，是一个应用层协议， 其帧结构被称为 APDU，APDU 一般由 APCI 和 ASDU组成.

APDU (Application Protocol Data Unit, 应用协议数据单元)是一个iec104 的协议帧. 一个APDU=一个APCI `[+ 一个ASDU]`= 0x68 + APDU_Length + APDU_Body(APDU_Length * byte).

> max(APDU)=255, max(APDU body)=253, max(ASDU)=249

![APDU frame](/misc/img/develop/iot/71460cacb4a098b327b075814f1d17e5.png)

#### APCI
ref:
- [APDU 序列号](https://blog.redisant.cn/docs/iec104-tutorial/chapter10/)

APCI (Application Protocol Control Information, 应用控制信息，类似于帧头），由一个1byte 的起始字节0x68 + 1 byte ADPU 的长度 + 4 个1 byte控制位域（`CF<n:1~4>`）组成.

APCI 中第一个控制位域（CF1）的最低2bit，确定了帧的格式，iec104 定义了3种格式的帧:
- I-format (information transfer format, 信息帧), last bit of CF0 是0

    I帧, 传输应用数据，捎带确认对方的发送. 它含发送序号，接收序号.

    ![](/misc/img/develop/iot/6ea5226decaa48329c0f52c4b97883e8.png)

    1. 它用于控制RTU（server， slave） 和 类SCADA（client, master）之间的信息传输
    1. I-format 的数据帧（APDU）总是包含ASDU
    1. I-format 的控制位域表明了消息的方向，其包含了两个15bit 的序号数字，每个方向上，每个APDU的序号数字都会被有序的加1, 并且在0～32767之间循环.

        1. TCP 连接建立后，发送/接收序号应当被置0
        1. 发送器在发送一个iFrame(I帧)后，会将发送端的发送序号自动加1，同时将该iFrame保存在发送缓冲区中， 直到它接收到一个ADPU，该APDU中接收序号表明接收到发送端发送的对应发送序号及以下的iFrame，这些iFrame会被从发送缓冲区移除
        1. 接收器接收到一个iFrame后，会将接收端的接收序号自动加1，当接收序号到达设定的数量后，会给发送端回应一个sFrame 的Ack。如果在一定的时间内，接收端接收的iFrame 未到达该设定的数量，接收端也会发送一个sFrame的Ack。如果接收端在一定的时间内都处于idle状态，且存在没有回应的iFrame, 接收端就会给其回应一个sFrame的Ack
    1. 发送/接收序号由CF位域由LSB(低7bit) 和MSB(高8bit) 构成，I-Format的帧序号只有15bit

    序号:
    - 发送序列号N（S）和接收序列号（R）的使用域ITU-T X.25定义的方法一致. 两个序列号在每个APDU和每个方向上都应按顺序加一。发送方增加发送序列号N（S），接受方增加接收序列号N（R）.
    - 发送序列号 N(S)：表示当前发送的 I 格式 APDU 的序列号。每发送一个 I 格式 APDU，该序号就自增1
    - 接收序列号 N(R)：表示发送方期待接收到的下一个 I 格式 APDU 的序列号。这实际上是发送方对之前收到的数据的一个确认。当接收方发送一个包含 N(R) 的 I 或 S 格式 APDU 时，就表示它已经成功接收到了所有小于 N(R) 的数据
- S-format (numbered supervisory functions, 监视帧), last bits of CF1 是 01

    S帧为短帧，为计数的监视功能类型，用于确认接收的I帧，长度仅6个字节。无应用数据可传输时，带接受序号确认已经收到的信息.

    ![](/misc/img/develop/iot/a6e52f865ed4452b9b943acaa1030583.png)

    1. 一般作为一个/多个iFrame的Ack ， 固定APDU 长度
    1. S-format APDU 只有APCI， 没有ASDU
    1. 在数据传输仅在一个方向上进行的任何情况下，必须在超时、缓冲区溢出或超过允许的最大 I 格式 APDU 数量而无确认之前向另一个方向发送 S 格式 APDU.

        通信的双方只有一方在不断发送数据 (I 格式 APDU)，另一方（接收方）也必须定期地、主动地发送 S 格式 APDU 来确认收到的数据. 这样做是为了避免发送方因为长时间没有收到确认而误判数据丢失，导致不必要的重传，或者因为缓冲区满了而停止发送.

        时间: 超时
        1. 超时 (Timeout)：发送方有一个定时器 t1。如果发送了 I 格式 APDU 后，在 t1 时间内没有收到对方的确认（无论是 I 格式 APDU 中的 N(R) 还是 S 格式 APDU），发送方就会认为数据丢失，进行重传. 为了避免这种情况，**接收方必须在发送方 t1 超时前发送确认**.
        1. 缓冲区溢出 (Buffer Overflow)：发送方和接收方都有内部缓冲区来存储待发送和已接收但未处理的数据。如果接收方不及时确认数据，发送方的待确认缓冲区可能会满。一旦满了，发送方就无法再发送新的数据，导致通信中断。 
        1. 超过允许的最大 I 格式 APDU 数量而无确认 (Exceeding K)：这是协议中的 K 值。K 值规定了发送方在未收到确认的情况下，最多可以发送多少个 I 格式 APDU。当发送的 I 格式 APDU 数量达到 K 值上限，而尚未收到这些数据的确认时，发送方必须停止发送新的 I 格式 APDU，直到收到确认

- U-format (unnumbered control functions, 控制帧), last bits of CF2 是 11

    U帧为不计数的控制功能类型，用于传输链路控制命令的报文，U格式帧为短帧，用于启动控制信息（V表示生效、C表示确认）.

    ![](/misc/img/develop/iot/255bd8ee17f74b57b2fa7bdce9f1ea6f.png)

    1. 被用于有序的控制功能， 固定APDU 长度
    1. U-format 的APDU只有一个APCI，没有ASDU
    1. uFrame 用于STARTDT（开启数据传输），STOPDT（关闭数据传输）和TESTFR（测试帧）的激活&确认机制
    1. STARTDT和STOPDT 用于client（master，也称控制站点）去控制Server（Slave，也称被控制站点）去开启/关闭数据传输；当连接建立时，用户数据传输是没有被使能的（默认是处于STOPDT状态的），在这种状态下，客户端通过这个连接是不能发送仍何用户数据的（uFrame是可以发送的）。客户端必须发送一个**STARTDT 激活（STARTDT activate）指令去激活用户数据的传输，服务器端将会回应一个STARTDT 确认（STARTDT confirm）**消息。如果没有收到该确认消息，client将会关闭此连接。

       只有client才可以发送STARTDT 激活指令。当连接建立好后，client 才可以向server 发送STARTDT激活指令，该指令只能被发送一次。激活后，该连接才可以在仍何时间发送仍何消息， 直到连接被STOPDT激活指令终止。

    1. client & server必须周期性地发送TESTFR帧，去检测所有连接的连接状态，和通信问题等.

       client & server必须周期性地发送**TESTFR 激活（TESTFR activate）指令，对应的TESTFR确认（TESTFR confirm）**帧必须被回应。

       在一定的时间内，连接没有数据传输时，client/server 就可以启动这个测试进程

![APCI Control Field 1, CF1](/misc/img/develop/iot/2733b69cf08009ecdfd8a1c40285a633.png)

#### ASDU
ref:
- [命令映射/地址映射](https://docs.emqx.com/zh/neuronex/latest/configuration/south-devices/iec-104/iec-104.html#%E5%9C%B0%E5%9D%80%E7%A4%BA%E4%BE%8B)
- [**IEC104规约报文实例分析.pdf**](/misc/pdf/develop/iot/IEC104规约报文实例分析.pdf)

ASDU包含两个主要的段：数据单元识别符（长度固定为6Byte）和数据段。数据段由一个或者多个信息对象构成。数据单元识别符定义了数据的类型，提供数据标识的寻址，包含额外的信息，如传输原因等。 每一个ASDU可以传输最大127个信息对象.

![ASDU](/misc/img/develop/iot/ccb70bcb922daf73f2dc0470d5bf1452.png)
![ASDU](/misc/img/develop/iot/asdu.png)

ASDU组成
1. 数据单元识别符(data unit identifier)

    数据单元识别符包含以下位域：
    1. Type identification (TypeID, 1 byte)

       - TypeID 的值，0不可用，1～127用于标准的IEC101协议定义。128～135 用于消息路由，135～255为特殊使用。
       - 对于标准的IEC101协议，有58个类型被定义.

        | 类型ID    | 分组        |
        |---------|-----------|
        | 1-40    | 监控方向的处理信息 |
        | 45-51   | 控制方向处理信息  |
        | 70      | 监控方向的系统信息 |
        | 100-106 | 控制方向系统信息  |
        | 110-113 | 控制方向参数    |
        | 120-126 | 文件传输      |
       - 值的注意的是TypeID 贯穿于整个ASDU，如果有多个信息对象被包含在该ASDU中，这些信息对像就有相同的类型
    1. SQ (Structure Qualifier) bit

        ![SQ](/misc/img/develop/iot/ae1a8494035b9c11111db8753a5a303f.png)

        SQ 位域指定了信息对象&信息元素如何被编址:
        1. SQ=0 (一系列的信息对象):
            - 每个单个元素或元素组合包含在信息对象里即由信息对象地址寻址. ASDU 可能由一个或者多个相同类型的信息对象组成，这些信息对象的长度定义在Number of Objects 位域
            - Q=0 表示信息对象序列，其中**每个对象都有自己的信息对象地址**。信息对象的数量由Number Of Objects定义。因此它们可以装载多达127个信息对象。
        1. SQ=1 (仅只有一个信息对象)
            编址一种信息对象的单个或者多个信息元素.

            1. 一系列相同的信息元素（例如，相同格式的测量值）被通过information object address 位域寻址。信息对象的地址就是第一个信息元素的地址。信息元素根据不同的偏移被寻址。这些信息元素的长度定义在Number of Objects 位域. 在这种情况，该ASDU只有一个信息对象，信息对象由一系列的信息元素组成.
            1. 当SQ=1时，ASDU只有一个信息对象， 这个对象包含了一系列的信息元素。所有信息对象都具有相同的格式，例如测量值。只有一个信息对象地址，即第一个信息元素的地址, 其他信息元素地址都是第一个信息元素的地址累加得到.

        总召唤时, 从站应答总召唤时采用sq=1减小数据量; 从站突发数据时, 地址不连续, 采用sq=0
    1. Number of objects/elements

        1. 范围为0～127
        1. 0 表示没有包含信息对象
        1. 1～127 表示信息对象/信息元素的个数

        SQ + Number of objects = Variable structure qualifier(可变结构限定词)
    1. T (test) bit

        只用于测试，不会控制过程或改变系统状态

        T=0 (非测试模式), T=1 (测试模式)
    1. P/N (positive/negative) bit

        积极/消极的激活确认。

        当使用控制命令时，这个位域是有意义的。该位域通常表示控制命令是否被成功执行。P=0表示积极确认，P=1表示消极确认。
        P/N 与控制命令一起使用时有意义。当控制命令在监控方向上镜像时，将使用该位，它指示命令是否已执行. 非控制命令，这个位域总是置0。
    1. Cause of transmission (COT)

        ref:
        - [传送原因的语义归总](https://blog.redisant.cn/docs/iec104-tutorial/chapter7/)
        - [Cause of Transmission](https://www.opcturkey.com/uploads/v5-iec-60870-5-104-master-manual.pdf) = [](/misc/pdf/develop/iot/v5-iec-60870-5-104-master-manual.pdf)
        - [Cot (Cause of Transmission)](https://iec104-python.readthedocs.io/v1.18.0/python/enum/cot.html)
        - [Cause of transmission (COT)](https://infosys.beckhoff.com/english.php?content=../content/1033/tf6500_tc3_iec60870_5_10x/984444939.html&id=)

        COT COT 字段用于控制通信网络上和站内消息的路由，通过 ASDU 指向正确的程序或任务进行处理。控制方向的 ASDU 是确认的应用服务，可以在监控方向镜像，传输原因不同.
        COT 是一个6位码, 用于解释目标站的信息
        0 没有被定义， 1～47用于标准定义（兼容范围）。48-63 为特殊目的使用(私有范围).

        **注意**: 网上部分文档直接将COT+ORG合称为COT.
    1. Originator Address (ORG)

        用来记录是哪个主站的召唤, 一般情况下不适用(置为0).

        - 源发站地址在系统基础上是可选的。它为控制站提供了一种明确标识自身的方式。当系统中只有一个控制站时，这不是必需的，但当有多个控制站或某些站是双模站时，这是必需的。在这种情况下，源发站地址可用于将命令确认定向回特定控制站，而不是整个系统。
        - 源发站地址将镜像 ASDU 和在监控方向（例如，通过一般询问进行询问）中询问的 ASDU 定向到激活该过程的源。
        - 如果未使用源发站地址（位设置为零）并且系统中定义了多个源，则必须将监控方向的 ASDU 定向到系统的所有相关源。在这种情况下，特定受影响的源必须选择其特定的 ASDU
    1. ASDU Address Field (Common Address of ASDU, COA)

        **IEC 104 协议通过在 ASDU 中配置唯一的 ASDU 公共地址 (CA) 来确保主站能够准确识别和管理每一个从站**

        **ASDU 的公共地址与数据本身所含的信息对象地址相结合，构成每个数据元素的唯一地址**.

        - 该地址称为公共地址，是因为它与包含在ASDU内的所有对象相关联。其经常被解释为站点地址, 用来**区分此链路上不同的子站**。但是它可以被构造为形成一个站点/扇区地址，其中各个站点由多个逻辑单元构成.
        - COA 是两个字节的长度: 低8bit + 高8bit
        - 全局地址也叫做广播地址，它会发送给所有的站点。控制方向上的广播类ASDU必须在监控方向上由特定定义的公共地址（站地址）的地址应答.
        - 0不被用， 1～65534 被定义为站点地址。 65535 被定义为广播地址。
        - 当相同功能的应用被启动时，使用广播地址。它仅限于以下ASDU：
            1. TypeID=100 (询问命令): 在公共时间使用特定系统数据快照进行回复
            1. TypeID=101 (反询问命令): 在公共时间冻结总计
            1. TypeID=103 (时钟同步命令): 同步时钟到通用时间
            1. TypeID=105 (复位进程命令): 同时复位

2. object * N

    ASDU在其结构中传输信息对象，每一个信息对象都被信息对象地址（information object address,IOA）编址。IOA用以识别站点内定义的数据。IEC104中，信息对象地址（ IOA）的长度为3byte。在控制方向上，该地址为目标地址，监控方向上，该地址为源地址。

    - 通常情况下，IOA 的地址范围被限制到最大35535（2 byte）。在特殊情况下，IOA的第三个字节仅用于结构化信息对象地址的情况，以便在特定系统中定义明确的地址。
    - 如果信息对象地址在某些 ASDU 中不相关（未使用），则将其设置为0

    **在同一个从站（即同一个公共地址 CA 下）IOA 必须是唯一(推荐, 但取决于具体实现); 在不同从站之间可以重复**

    > 实际: 同一从站（相同 CA）内部，同一TypeId下的 IOA 必须是唯一的; 同一从站（相同 CA）内部，不同TypeId之间的 IOA 可以重复. 原因: 一个物理点可能同时产生遥测和遥信数据，或者既可以被遥测也可以被遥控. 在这种情况下，相同的 IOA 能够方便地将这些不同类型的数据关联到同一个物理实体.

    > IEC 60870-5-101/104标准没有禁止不同Type ID使用相同IOA
    
    > 如果IOA重复, 则响应内容取决于server实现.

    以object M_SP_TB_1举例:
    1. 单点信息 (Single Point Information, SPI)
    1. 品质描述字 (Quality Descriptor, QDS)
    1. CP56Time2a = 图SQ中的`Time Tag`

在一个ASDU中被传输的所有信息对象，都必须有相同的ASDU Type. 如果有多个不同类型的信息对象，它们必须被装载进不同的ASDU中传输.

在IEC104 协议中，每一个ASDU类型，都有一对应的消息对象格式.

### ASDU类型&描述
信息对象格式ref:
- [Standard IEC 60870-5-104 data types](https://infosys.beckhoff.com/english.php?content=../content/1033/tf6500_tc3_iec60870_5_10x/984070283.html&id=)

    部分未描述类型的定义见`Standard IEC 60870-5-101 data types`
- [Standard IEC 60870-5-101 data types](https://infosys.beckhoff.com/english.php?content=../content/1033/tf6500_tc3_iec60870_5_10x/984528523.html&id=)
- [详解IEC104 规约【最详细版】](https://blog.csdn.net/changqing1990/article/details/134327980)

对于每一种ASDU的类型，IEC104 都定义了对应的信息对象类型

1. 监视方向上的过程信息

    | 类型标识  | 描述                            | 引用        | 信息对象格式                          | 合法的COT                |
    |-------|-------------------------------|-----------|---------------------------------|-----------------------|
    | 0     | 未定义                   |           |                                 |                       |
    | 1     | 单点信息                          | M_SP_NA_1 | SIQ                             | 2,3,5,11,20,20+G      |
    | 3     | 双点信息                          | M_DP_NA_1 | DIQ                             | 3,5,11,12             |
    | 5     | 步位置信息                         | M_ST_NA_1 | VTI + QDS                       | 2,3,5,11,12,20,20+G   |
    | 7     | 32比特串                         | M_BO_NA_1 | BSI + QDS                       | 2,3,5,11,12,20,20+G   |
    | 9     | 归一化测量值                        | M_ME_NA_1 | NVA + QDS                       | 2,3,5,11,12,20,20+G   |
    | 11    | 标量化测量值                        | M_ME_NB_1 | SVA + QDS                       | 2,3,5,11,12,20,20+G   |
    | 13    | 浮点型测量值                        | M_ME_NC_1 | IEEE STD 754 + QDS              | 2,3,5,11,12,20,20+G   |
    | 15    | 累计值                           | [M_IT_NA_1](https://infosys.beckhoff.com/english.php?content=../content/1033/tf6500_tc3_iec60870_5_10x/984528523.html&id=) | BCR                             | 2,37,37+G             |
    | 20    | 带状态检出的成组单点信息                  | M_PS_NA_1 | SCD+QDS                         | 2,3,5,11,12,20,20+G   |
    | 21    | 不带品质描述的归一化测量值                 | M_ME_ND_1 | NVA                             | 1,2,3,5,11,12,20,20+G |
    | 22～29 | 为将来的兼容定义保留                    |           |                                 |                       |
    | 30    | 带时标CP56Time2a的单点信息            | M_SP_TB_1 | SIQ+ CP56Time2a                 | 3,5,11,12             |
    | 31    | 带时标CP56Time2a的双点信息            | M_DP_TB_1 | DIQ+ CP56Time2a                 | 3,5,11,12             |
    | 32    | 带时标CP56Time2a的步位置信息           | M_ST_TB_1 | VTI + QDS+ CP56Time2a           | 2,3,5,11,12           |
    | 33    | 带时标CP56Time2a的32比特串           | M_BO_TB_1 | BSI + QDS+CP56Time2a            | 3,5                   |
    | 34    | 带时标CP56Time2a的归一化测量值          | M_ME_TD_1 | NVA + QDS+CP56Time2a            | 3,5                   |
    | 35    | 带时标CP56Time2a的标量化测量值          | M_ME_TE_1 | SVA + QDS+CP56Time2a            | 3,5                   |
    | 36    | 带时标CP56Time2a的浮点型测量值          | M_ME_TF_1 | IEEE STD 754 + QDS+CP56Time2a   | 2,3,5,11,12,20,20+G   |
    | 37    | 带时标CP56Time2a的累计值             | M_IT_TB_1 | BCR+CP56Time2a                  | 3,37,37+G             |
    | 38    | 带时标CP56Time2a的继电器保护装置事件       | M_EP_TD_1 | SEQ+CP16Time2a+CP56Time2a       | 3                     |
    | 39    | 带时标CP56Time2a的继电器保护装置成组启动事件   | M_EP_TE_1 | SEP + QDP+CP16Time2a+CP56Time2a | 3                     |
    | 40    | 带时标CP56Time2a的继电器保护装置成组输出电路信息 | M_EP_TF_1 | OCI + QDP+CP16Time2a+CP56Time2a | 3                     |
    | 41～44| 为将来的兼容定义保留                    |           |                                 |                       |

    类型表示1～15中，单数是不带时标的信息元素，双数是带时标CP24Time2a的对应信息元素。其对象格式，是给不带时标的信息元素格式的基础上+CP24Time2a.
    引用的命名格式如下：
    - M_ ：监视方向的信息元素
    - _Nx：不带时标
    - _Tx： 带时标
    - _xA：type A: 有质量描述副的状态或归一化值
    - _xB：type B: 有质量描述副的标量值
    - _xC：type C: 有质量描述副的浮点值
    - _xD：type D: 没有有质量描述副的归一化值
    信息对象格式描述了信息对象由那些信息元素组成

    时间相关:
    - `_NA_`: 没有时标
    - `_TA_`: 带CP24Time2a时标
    - `_TB_`: 带CP56Time2a时标

    时标:
    - CP56Time2a: 7B, 完整时间信息, 精确到毫秒
    - CP24Time2a: 3B, 短时间信息, 提供分+毫秒, `年/月/日/时`由master提供

        CP24Time2a 是一种紧凑高效的时间戳格式，其完整性依赖于与系统本地时间的结合
    - CP16Time2a: 2B, 提供毫秒

    > M_EP_TB_1, M_EP_TE_1每次仅包含一个信息对象.

1. 控制方向上的过程信息

    | 类型标识  | 描述                      | 引用        | 信息对象格式                       | 合法的COT                 |
    |-------|-------------------------|-----------|------------------------------|------------------------|
    | 45    | 单命令                     | C_SC_NA_1 | SCO                          | 6,7,8,9,10,44,45,46,47 |
    | 46    | 双命令                     | C_DC_NA_1 | DCO                          | 6,7,8,9,10,44,45,46,47 |
    | 47    | 步调节命令                   | C_RC_NA_1 | RCO                          | 6,7,8,9,10,44,45,46,47 |
    | 48    | 设点命令，归一化值               | C_SE_NA_1 | NVA + QOS                    | 6,7,8,9,10,44,45,46,47 |
    | 49    | 设点命令，标量值                | C_SE_NB_1 | SVA + QOS                    | 6,7,8,9,10,44,45,46,47 |
    | 50    | 设点命令，短浮点值               | C_SE_NC_1 | IEEE STD 754 +QOS            | 6,7,8,9,10,44,45,46,47 |
    | 51    | 32比特串                   | C_BO_NA_1 | BSI                          | 6,7,8,9,10,44,45,46,47 |
    | 52～57 | 为将来的兼容定义保留              |           |                              |                        |
    | 58    | 带时标CP56Time2a的单命令       | C_SC_TA_1 | SCO+CP56Time2a               | 6,7,8,9,10,44,45,46,47 |
    | 59    | 带时标CP56Time2a的双命令       | C_DC_TA_1 | DCO+CP56Time2a               | 6,7,8,9,10,44,45,46,47 |
    | 60    | 带时标CP56Time2a的步调节命令     | C_RC_TA_1 | RCO+CP56Time2a               | 6,7,8,9,10,44,45,46,47 |
    | 61    | 带时标CP56Time2a的设点命令，归一化值 | C_SE_TA_1 | NVA + QOS+CP56Time2a         | 6,7,8,9,10,44,45,46,47 |
    | 62    | 带时标CP56Time2a的设点命令，标量值  | C_SE_TB_1 | SVA + QOS+CP56Time2a         | 6,7,8,9,10,44,45,46,47 |
    | 63    | 带时标CP56Time2a的设点命令，短浮点值 | C_SE_TC_1 | IEEE STD 754 +QOS+CP56Time2a | 6,7,8,9,10,44,45,46,47 |
    | 64    | 带时标CP56Time2a的32比特串     | C_BO_TA_1 | BSI+CP56Time2a               | 6,7,8,9,10,44,45,46,47 |
    | 65～69 | 为将来的兼容定义保留              |           |                              |                        |

    引用的命名格式 C_ ：控制方向的信息对象.
    **在控制方向传送过程信息给指定站时，可以带或者不带时标，但对某一给定的站，两者不可混合发送**
    注：在控制方向上具有”CON“标记的ASDU是被确认的应用服务，在监视方向上可以用不同的传送原因镜像同样的报文内容. 这些镜像ASDU用作肯定或否定认可（确定）. 即监视方向上返回确认结果.

    > 104协议的读地址与写地址是分离的，一个点位地址(IOA)位要么是读点位要么是写点位，不存在同时可读可写的点位

1. 监视方向上的系统信息

    | 类型标识  | 描述         | 引用        | 信息对象格式 | 合法的COT |
    |-------|------------|-----------|--------|--------|
    | 70    | 初始化结束      | M_EI_NA_1 | COI    | 4      |
    | 71～99 | 为将来的兼容定义保留 |           |        |        |

1. 控制方向上的系统信息

    | 类型标识    | 描述                     | 引用        | 信息对象格式     | 合法的COT                 |
    |---------|------------------------|-----------|------------|------------------------|
    | 100     | 总召唤命令(召唤全数据)                  | C_IC_NA_1 | QOI        | 6,7,8,9,10,44,45,46,47 |
    | 101     | 电能脉冲召唤命令               | C_CI_NA_1 | QCC        | 6,7,8,9,10,44,45,46,47 |
    | 102     | 读命令                    | C_RD_NA_1 | 无          | 5                      |
    | 103     | 时钟同步命令                 | C_CS_NA_1 | CP56Time2a | 3,6,7,44,45,46,47      |
    | 104     | (IEC 101) Test command | C_TS_NB_1 | FBP        | 6,7,44,45,46,47        |
    | 105     | 复位进程命令                 | C_RP_NC_1 | QRP        | 6,7,44,45,46,47        |
    | 107     | 带时标CP56Time2a的测试命令     | C_TS_TA_1 |            |                        |
    | 108～109 | 为将来的兼容定义保留             |           |            |                        |

    > M_IT_NA_1属于C_CI_NA_1的上报内容

1. 控制方向上的参数

    | 类型标识                                                 | 描述         | 引用        | 信息对象格式            | 合法的COT                       |
    |------------------------------------------------------|------------|-----------|-------------------|------------------------------|
    | 110                                                  | 归一化测量值     | P_ME_NA_1 | NVA + QPM         | 6,7,9,10,20,20+G,44,45,46,47 |
    | 111                                                  | 标量化测量值     | P_ME_NB_1 | SVA + QPM         | 6,7,20,20+G,44,45,46,47      |
    | 112                                                  | 浮点测量值      | P_ME_NC_1 | IEEE STD 754 +QPM | 6,7,20,20+G,44,45,46,47      |
    | 113                                                  | 参数激活       | P_AC_NA_1 | QPA               | 6,7,8,9,44,45,46,47          |
    | 114～119                                              | 为将来的兼容定义保留 |           |                   |                              |
    | 参数都是控制方向上的，和监控方向的对象相比，其值发生变化时，不会上报，只有总召唤时，可以上报给数据的值。 |            |           |                   |                              |

    引用的命名格式 P_ ：控制方向的参数.

1. 文件传输

    | 类型标识 | 描述                 | 引用        | 信息对象格式                      | 合法的COT |
    |------|--------------------|-----------|-----------------------------|--------|
    | 120  | 文件已准备好             | F_FR_NA_1 | NOF + LOF + FRQ             | 13     |
    | 121  | 节点已准备好             | F_SR_NA_1 | NOF + NOS + LOF +SRQ        | 13     |
    | 122  | 召唤目录，选择文件，召唤文件，选择节 | F_SC_NA_1 | NOF + NOS + SCQ             | 5，13   |
    | 123  | 最后的节，最后的段          | F_LS_NA_1 | NOF + NOS + LSQ +CHS        | 13     |
    | 124  | 确认文件，确认节           | F_AF_NA_1 | NOF + NOS + AFQ             | 13     |
    | 125  | 段                  | F_SG_NA_1 | NOF + NOS + LOS +segement   | 13     |
    | 126  | 目录                 | F_DR_TA_1 | NOF + LOF + SOF +CP56Time2a | 3，5    |
    | 127  | 日至查寻-请求存档文件        | F_SC_NB_1 |                             |        |

    引用的命名格式 F_ ：文件传输.

![其他参考信息的types](/misc/img/develop/iot/6736f08b7b67b97f490f3f83aff0389c.png)

![常见typ](/misc/img/develop/iot/iec104.common.type.png)

部分引用前缀说明:
- M_SP：（Single-point information without time tag, bool）单点信息，无时标：表示单个数字量输入（如开关的开/关状态）。在IEC 104中，通常表示为M_SP_NA_1
- M_DP：（Double-point information without time tag, char）双点信息，无时标：表示一对相关联的数字量输入（如开关的中间状态和两端状态）。在IEC 104中，通常表示为M_DP_NA_1
- M_ST：（Step position information, char）步位置信息：表示步进位置信息，通常用于表示一个位置的多个状态。在IEC 104中，通常表示为M_ST_NA_1
- M_BO：（Bitstring of 32 bits, DWord）位串信息：表示32位的位串，可以用于表示多个状态或信息。在IEC 104中，通常表示为M_BO_NA_1
- M_ME_NV：（Measured value, normalized value, float）测量值，归一化值：表示归一化的模拟量输入（如电压或电流的百分比值）。在IEC 104中，通常表示为M_ME_NA_1
- M_ME_SV：（Measured value, scaled value, short）测量值，标度化值：表示标度化的模拟量输入，使用特定的比例因子。在IEC 104中，通常表示为M_ME_NB_1
- M_ME_FV：（Measured value, short floating point number, float）测量值，短浮点数：表示短浮点数形式的模拟量输入，更高精度的模拟量值。在IEC 104中，通常表示为M_ME_NC_1
- M-IT：（Integrated totals, long）集成总值：表示集成总值，通常用于累计的测量值（如能量消耗）。在IEC 104中，通常表示为M_IT_NA_1

### 信息元素详解
信息元素是构成信息对象的基本单元，就像OOP 中的变量一样，是构成Object的基础.

给出一个IEC104的信息元素列表：
1. 监视方向的过程信息

    | 元素类型         | 描述          | 长度（byte） | 使用的信息对象                                               |
    |--------------|-------------|----------|-------------------------------------------------------|
    | SIQ          | 有质量描述符的单点信息 | 1        | 1, 2, 30                                              |
    | DIQ          | 有质量描述符的双点信息 | 1        | 3                                                     |
    | BSI          | 二进制状态信息     | 4        | 7, 8, 33, 51                                          |
    | SCD          | 状态更改探测      | 4        | 20                                                    |
    | QDS          | 质量描述符       | 1        | 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 20, 32, 33, 34, 36 |
    | VTI          | 具有瞬态指示值     | 1        | 5, 6, 32                                              |
    | NVA          | 归一化值        | 2        | 9, 10, 21, 34, 48, 110                                |
    | SVA          | 标度值         | 2        | 11, 12, 49, 111                                       |
    | IEEE STD 754 | 短浮点数        | 4        | 13, 14, 36, 50, 112                                   |
    | BCR          | 二进制计数器读数    | 5        | 15, 16, 37                                            |

    - SIQ
        | bit7 | bit6 | bit5 | bit4 | bit3 | bit2 | bit1 | bit0 |
        |------|------|------|------|------|------|------|------|
        | IV   | NT   | SB   | BL   | 0    | 0    | 0    | SPI  |

        - IV：VALID (0) / INVALID (1)。数据值是否有效，当采集系统识别到异常的情况（如更新设备丢失或无法运行），将这个位域标为1。该情况下信息对象的值，不会被定义。这个位为1表示信息对象的值是不正确的，不能被用。
        - NT： TOPICAL (0) / NOT TOPICAL (1) NT为刷新标志位，若最近的刷新成功则值就称为当前值，若一个指定的时间间隔内刷新不成功或者其值不可用,值就称为非当前值。设备处于调试态或装置通讯中断都有可能造成非当前值。
        - SB：NOT SUBSTITUTED (0) / SUBSTITUTED (1) SB为取代标志位，当信息对象的值由值班员(调度员)输入（即人工置数）或者由当地自动原因（模拟遥信）所提供时，即为被取代。如人工置数情况下。这意味着该值不是从正常测量中得出的。
        - BL：NOT BLOCKED (0) / BLOCKED (1) BL为封锁标志位，信息对象的值为传输而被封锁，值保持封锁前被采集的状态。封锁和解锁可以由当地联锁机构或当地自动原因启动。
        - SPI： OFF (0) / ON (1) SPI为遥信状态值。单点遥信，0分1合；双点遥信，1开2合，0和3为中间状态

    - DIQ
        | bit7 | bit6 | bit5 | bit4 | bit3 | bit2 | bit1~bit0 |
        |------|------|------|------|------|------|-----------|
        | IV   | NT   | SB   | BL   | 0    | 0    | DPI       |

        DPI: Double Point Information SPI为遥信状态值。双点遥信，1=OFF， 2=ON，0和3为不确定中间状态


1. 保护

    | 元素类型 | 描述           | 长度（byte） | 使用的信息对象        |
    |------|--------------|----------|----------------|
    | SEP  | 保护设备的单个事件    | 1        | 17, 38         |
    | SPE  | 保护设备启动事件     | 1        | 18, 39         |
    | OCI  | 保护设备输出电路信息   | 1        | 19, 40         |
    | QDP  | 保护设备事件的质量描述符 | 1        | 18, 19, 39, 40 |

1. 命令

    | 元素类型 | 描述     | 长度（byte） | 使用的信息对象 |
    |------|--------|----------|---------|
    | SCO  | 单个命令   | 1        | 45      |
    | DCO  | 双命令    | 1        | 46      |
    | RCO  | 调节阶跃指令 | 1        | 47      |

1. 时间

    | 元素类型       | 描述       | 长度（byte） | 使用的信息对象                                                                          |
    |------------|----------|----------|----------------------------------------------------------------------------------|
    | CP56Time2a | 七字节二进制时间 | 7        | 4, 6, 8, 10, 12, 14, 16, 17, 18, 19, 31,32, 33, 34, 36, 37, 38, 39, 40, 103, 126 |
    | CP24Time2a | 三字节二进制时间 | 3        | 4, 5, 6, 8, 10, 12, 14, 16, 17, 18, 19, 31, 32, 33, 34, 36, 37, 38, 39, 40       |
    | CP16Time2a | 二字节二进制时间 | 2        | 17, 18, 19, 38, 39, 40, 106                                                      |

1. 限定符

    | 元素类型 | 描述         | 长度（byte） | 使用的信息对象                |
    |------|------------|----------|------------------------|
    | [QOI](https://wiki.elseta.com/books/the-vinci-software/page/iec-60870-5-104)  | 讯问资格(02年修改后的规约中没有分组召唤)       | 1        | 100                    |
    | [QCC](https://support.mz-automation.de/doc/lib60870/latest/group__COMMON.html#ga241d1389f71d4079d5e71b06a109a57e)  | 反询问命令限定符   | 1        | 101                    |
    | QPM  | 测量值参数限定符   | 1        | 110, 112               |
    | QPA  | 参数激活的限定符   | 1        | 111, 113               |
    | QRP  | 重置过程命令的限定符 | 1        | 105                    |
    | QOC  | 命令的限定符     | 1        | 45, 46, 47, 48, 49, 50 |
    | QOS  | 设定值命令的限定符  | 1        | 48, 49, 50             |

1. 文件传输

    | 元素类型 | 描述        | 长度（byte） | 使用的信息对象                           |
    |------|-----------|----------|-----------------------------------|
    | FRQ  | 文件就绪限定符   | 1        | 120                               |
    | SRQ  | 节就绪限定符    | 1        | 121                               |
    | SCQ  | 选择并调用限定符  | 1        | 122                               |
    | LSQ  | 最后一节或段限定符 | 1        | 123                               |
    | AFQ  | 确认文件或节限定符 | 1        | 124                               |
    | NOF  | 文件名       | 2        | 120, 121, 122, 123, 124, 125, 126 |
    | NOS  | 段命名       | 2        | 121, 122, 123, 124, 125           |
    | LOF  | 文件/段的长度   | 3        | 120, 121                          |
    | LOS  | 分段长度      | 1        | 125                               |
    | CHS  | Checksum  | 1        | 123                               |
    | SOF  | 文件状态      | 1        | 126                               |

1. 杂项

    | 元素类型 | 描述             | 长度（byte） | 使用的信息对象 |
    |------|----------------|----------|---------|
    | COI  | 初始化原因          | 1        | 70      |
    | FBP  | 固定测试位模式，两个八位字节 | 1        | 104     |

## IEC104规约常用参数
- T0：建立连接超时。t0规定了主站端和子站RTU端建立一次TCP连接的最大允许时间。（建议30秒，主站如果通过TCP连接子站超过30秒还没有建立连接，则应该重新建立连接，如果多次连接都不成功，则进行相应的告警等处理）
- T1：发送或测试APDU的超时. t1规定发送方发送一个I格式报文或U格式报文后，必须在t1的时间内得到接收方的认可，否则发送方认为TCP连接出现问题并应重新建立连接；（建议15秒）
- T2: 无数据报文时确认的超时（T2 < T1）. t2规定接收方在接收到I格式报文后，若经过t2时间未再收到新的I格式报文，则必须向发送方发送S格式帧对已经接收到的I格式报文进行认可；（建议10秒）
- T3: 长期空闲状态下发送测试帧的超时（T3 > T1）. t3规定调度端或子站RTU端每接收一帧I帧、S帧或者U帧将重新触发计时器t3，若在t3内未接收到任何报文，将向对方发送测试链路帧；（建议20秒）
- K：未被确认的I格式APDU（k）最大数目；（默认值12，k值的最大范围：1 到 32767(2^15-1)APDUs, 精确到 1APDU. ）
- W：接收方收到w个I格式APDU后确认。（默认值8，w 值的最大范围：1 到 32767 APDUs, 精确到 1APDU, **建议：w 不应超过 k 的三分之二**）

发送12个APDU未收到确认报文，应终止传输；收到8个APDU则要回应发送方确认报文。因此要分别对发送、接收报文进行计数，当12条报文发送后没有收到确认的S格式报文或者I格式报文（包含对方接收报文数目信息），则断开链接，进行重连。在无信息回应对方情况下，收到8条报文后也应立即发送S格式的报文回应对方，以防对方断开链接.

## 参考代码
- [lib60870-C](https://github.com/mz-automation/lib60870)
- [iec104-python](https://github.com/Fraunhofer-FIT-DIEN/iec104-python)

    [doc](https://iec104-python.readthedocs.io/latest/index.html)

## 模拟器
- [IEC104/101 模拟器](https://www.redisant.cn/)

    未激活版:
    - server只允许使用"127.0.0.1", 且只支持一个从站
    - client只支持连接"127.0.0.1"

    - [IEC104/101 从站/服务端模拟器用户手册](https://gitee.com/chenjing9412/iec104-server-simulator-release/raw/master/104_server_user_manual.pdf)

        ```bash
        $ tar -zxvf IEC104ServerSimulator-1.0.0.0-linux-x64.tar.gz
        $ export LANG=en_US.UTF-8 #  设置语言环境（或略此步骤可能导致软件启动报错）
        $ chmod +x ./IEC104ServerSimulator-1.0.0.0-linux-x64/IEC104ServerSimulator
        $ ./IEC104ServerSimulator-1.0.0.0-linux-x64/IEC104ServerSimulator
        ```
    - [**IEC104/101 从站/服务端 模拟器用户手册**](https://blog.csdn.net/qq_32779119/article/details/144409402)
- [KW-2200配电网自动化测试系统](https://gitcode.com/Universal-Tool/ad3a3/)

## FAQ
### IEC 104的序号机制与TCP ACK
它们是不同协议层对可靠性需求的共同解决方案，但设计目标不同：
- TCP ACK：通用传输保障，面向任意字节流
- IEC 104序号：业务逻辑保障，面向电力控制命令的可靠交互

### IEC104数据映射到设备四遥后如何还原到104信息对象
1. 连接104后, 立即通过总召唤获取数据, 建立104信息对象与设备四遥的映射关系
2. 通过该映射关系, 获取设备四遥数据, 还原回104信息对象