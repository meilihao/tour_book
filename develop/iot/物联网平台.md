# 物联网平台
ref:
- [阿里云 - 物联网平台](https://help.aliyun.com/zh/iot/)
- [Fabric 是基于 EMQ 核心产品(EMQ X Enterprise、Neuron、NanoMQ、ekuiper、HstreamDB 等)构建的基础 IoT 平台框架](https://docs.emqx.com/zh/fabric/latest/)
- [主流物联网通信协议选型：TCP, MQTT, WebSocket, UDP, RTSP, Modbus TCP](https://mp.weixin.qq.com/s/JiPrZKcfMFedBcU6bs_lMQ)

book:
- 图解物联网

    科普物联网
- 从创意到原型:物联网应用快速开发

    最适合物联网专业学生和开发人员的书
- Internet of Things for Architects /  IoT and Edge Computing for Architects / 万物互联:物联网核心技术与安全 / 重构物联网的未来

    物联网架构师和技术领导者不可错过的书
- 从物联到万联:Node.js 与树莓派万维物联网构建实战

    实战

物联网涉及的知识非常庞杂 ,包括通信技术、嵌入式开发、互联网、大数据、人工智能等等,甚至还有相关应用领域的专业知识, 比如物流, 新能源等.

物联网从整个体系结构来看,可以分为三个层面:
1. 设备层(或感知层)
1. 传输层(这里包括网络层)
1. 应用层

    技术体系:
    1. 批处理, 流处理

        批处理适合海量静态数据的非实时处理,延迟比较高,也叫离线计算
        流处理适合动态输入的流式数据的实时处理,延迟低,也叫实时计算

        Flink是目前最优的流批一体数据处理框架
    1. 数据存储
    1. 数据可视化, 数据挖掘, 商业智能, 数据预测, 控制决策

    数据流程
    1. MQTT
    1. MQ
    
       1. 实现了 MQTT Broker 服务器和数据流处理服务器之间的解耦,双方没有直接的依赖, 以维护更新会更加方便 
       1. 可以平衡输入数据量的大小变化,所以数据流处理服务器不会因为骤增的压力而崩溃
    1. 处理
    1. Cache + DB

物联网功能:
1. 感知
1. 基于信息实现设备动控制

互联网的主体是人和信息, 互联网的主体是人、信息和设备, 物联网是互联网的发展和延伸.

## 物模型
物模型是物联网平台为产品定义的数据模型，用于描述产品的功能.

物模型是物理空间中的实体（如传感器、车载装置、楼宇、工厂等）在云端的数字化表示，从`属性、服务和事件`三个维度，分别描述了该实体是什么、能做什么、可以对外提供哪些信息。定义了物模型的这三个维度，即完成了产品功能的定义.

属性(Property): 描述了产品设备运行时的某种状态, 特点是可读可写
事件(Event): 类由产品设备在运行过程中产生的信息、告警和故障等, 事件是设备上报的,不能由应用来设置
服务(Service): 设备可以被调用的能力或者方法

物模型一般是用 JSON 来表述模型元素.

### 设备影子
设备影子用于 缓存设备状态. 应用程序可以通过设备影子直接获取设备最后一次更新的属性值,而无需每次都访问设备.

### 数字孪生(Digital Twin)
物模型是物理实体的数字化模型,但主要针对的是物联网中应用的开发和设备的互操作, 如果再集成了物理实体的各类数据,那就是物理实体的 忠实映射. 同时, 物理实体的整个生命周期中,它会和实体一起进化,积累各种信息和知识,并且促进物理实体
的优化, 这样的模型就是物理实体的数字孪生.

## 实景3D
[720云](http://720yun.com/)

## 平台
- 开源

    - [SagooIOT是一个基于golang开发的开源的企业级物联网基础开发平台](https://github.com/sagoo-cloud/sagooiot)

        golang
    - [FastBee 开源物联网平台](https://github.com/kerwincui/FastBee)

        java
    - [JetLinks 物联网基础平台](https://jetlinks.cn)
    - [IoT DC3](https://doc.dc3.site/)

        一个基于 Spring Cloud 的 100% 完全开源的、分布式的物联网(IoT)平台，用于快速开发物联网项目和管理物联设备，是一整套物联系统解决方案
    - [IoTSharp](https://iotsharp.net/)
    - [IoTGateway](http://iotgateway.net/)
    - [Yytek物联网云平台](https://gitee.com/zzxmgjy_admin/yytek-iot-cloud)
    - [Hummingbird 蜂鸟 & 一个轻量级物联网平台](https://doc.hummingbird.winc-link.com/)

        golang
    - [乐联开源/enjoy-iot](https://gitee.com/open-enjoy/enjoy-iot)
    - [PandaX是Go语言开源的企业级物联网平台低代码开发框架](https://gitee.com/XM-GO/PandaX)
        golang
    - [wisdom-智慧农业、农业平台、智慧农业物联网平台](https://www.51cto.com/article/771609.html)
    - [dgiot - 是国内首款轻量级开源工业物联网平台](https://www.51cto.com/article/771609.html)
    - [thinglinks - 一款高性、高吞吐量、高扩展性的物联网平台](https://gitee.com/mqttsnet/thinglinks)

        java
    - [Magistrala是一个现代化、可扩展、安全的开源物联网云平台，采用Go语言编写](https://www.zedyer.com/iot-knowledge/8-opensource-iot-platform/)
    - [iotkit-parent - 是一个开源的物联网基础开发平台](https://www.51cto.com/article/771609.html)
    - [thingspanel-go - 是Go语言开源插件化物联网平台](https://www.51cto.com/article/771609.html)

开源的智能家居平台有很多,热度比较高的平台有 5 个,分别是 Home Assistant、Domoticz、openHAB、Gladys Assistant 和 WebThingsIO.

# 传输层
## 无线通信
无线通信技术的 4 个重要参数: 
1. 频段

   Wi-Fi 的频段是 2.412GHz-2.484GHz. 这是一个 非授权频段 ,其他的通信术也可以使用. 这就是 Wi-Fi 路由器和蓝牙耳机、键鼠, 在某些情况下会相互干扰的原因.

1. 信道

    它是信息通过无线电波传送的具体通道介质。每种通信技术的频段会被划分、规划成多个 信道来使用. Wi-Fi 的频段被分为 14 个信道(中国可用的是 13 个信道,信道 14 排除在外).

    相邻信道的频段是存在重叠的。比如,Wi-Fi 的信道 1 频段是 `2.401GHz ~ 2.423GHz`, 信道 2 频段是 `2.406GHz ~ 2.428GHz`

1. 信道带宽

    信道频段的最大值和最小值之差,就是信道覆盖的范围大小,也叫信道带宽. 比如,Wi-Fi 信道1 的带宽是 22MHz,它是由 2.423GHz 减去 2.401GHz 得到的, 这22MHz 是信道 1 的实际带宽,而它的有效带宽只有 20MHz,因为其中有 2MHz是 隔离频带. 隔离频带主要是起保护作用的, 类似高速公路上的隔离带.

1. 传输速率

    选择通信技术的时候,传输速率是需要关注的重要指标

    传输速率受很多因素的影响,比如信道带宽和频率. 一般来说,带宽越大,传输速率就越大,就像路面越宽可以承载的通行车辆越多一样;频率比较高时,电磁环境相对比较干净、干扰少, 传输速率会更高,就像道路更平坦自然可以通行更多车辆一样.

    为了提高传输速率,越来越多的提高频段利用率的技术也被开发出来并投入使用,比如正交频分复用, MIMO(Multiple-Input Multiple-Output)等. 

实际应用中,不同的通信技术有不同的信道个数; 同一种技术, 不同的版本也会对信道做不同的划分.

### wifi
Wi-Fi 是 IEEE 802.11 无线网络标准的商品名, 包含多个版本, 比如802.11b、802.11g、802.11n等.

设备热点配网技术(小米米家的物联网平台): 让 Wi-Fi 设备先进入 Wi-Fi AP 的模式, 由设备创建出一个 Wi-Fi 热点, 然后让手机连接到这个热点, 接着把路由器 Wi-Fi 的 SSID 和密码发送给 Wi-Fi 设备, 此时手机也可以直接获取到设备的 MAC 地址, 然后Wi-Fi 设备再连接到路由器 Wi-Fi完成组网.

### BLE(Bluetooth Low Energy, 蓝牙)
连接电源线、不需要关心功耗的设备往往优先考虑 Wi-Fi, 功耗要求严格的设备优先考虑BLE. 无论是从芯片模组的价格考虑,还是从生态的丰富度考虑,它都是电池供电的智能设备的理想选择.

BLE 的频段是非授权的 2.400GHz-2.4835GHz, 采用 40 个带宽 2MHz 的通道.

蓝牙 5 更是针对物联网增加了很多特性,比如 Mesh 组网、更远的通信距离、更快传输速率(BLE 4.2 的 2 倍)和更大数据承载量的广播包(BLE 4.2 的 8 倍),此外还有厘米级精度的定位功能.

BLE 的数据通信主要基于 广播包 和 GATT 协议.

连接参数的调节对于 BLE 设备的扫描和连接等影响很大。这些参数包括广播间隔、最大连接间隔、最小连接间隔和连接监听时间等,它们都可以在设备的固件开发中进行调整。比如广播间隔会影响扫描的响应速度,也会对设备的功耗有影响,所以需要平衡功耗和响应速度的不同需求, 选择一个合适的值.

BLE 设备可以在 4 种模式下工作: 
1. 广播模式 (Broadcaster),这里特指单纯的广播模式。这种模式下设备不可以被连接只能够以一定的时间间隔把数据广播出来,供其他设备使用,比如手机扫描处理。蓝牙Beacon 设备就是工作在这种模式 
1. 从机模式 (Peripheral),这种模式下设备仍然可以广播数据,同时也可以被连接。建立连接后,双方可以进行双向通信
1. 主机模式 (Central),这种模式下设备不进行广播,但是可以扫描周围的蓝牙广播包发现其他设备,然后主动对这些设备发起连接
1. 观察者模式 (Observer),这种模式下设备像主机模式一样,也不进行广播,而是扫描围的蓝牙广播包,但是不同的地方是,它不会与从机设备建立连接。一般收集蓝牙设备播包的网关就是在这种模式下工作的,它会将收集的广播数据通过网线、Wi-Fi 或者 4G等蜂窝网络上传到云平台

### ZigBee

### LoRa
穿透能力强、空旷环境通信范围可以达到几公里的技术

### 2G
在 Wi-Fi 流行之前,智能手机进行数据通信的主要方式是 蜂窝通信技术. 2G 是相对早期的蜂窝通信技术, 目前在退网中.

### LTE-Cat1 & NB-IoT
NB-IoT 模组的价格已经和 2G 模组基本持平; LTE-Cat1 的模组相比要贵一些, 但是也要远低于 4G 模组的价格.

LTE-Cat1 属于 4G 网络的低速类别.

LTE-Cat1 的带宽是 20MHz,上行速率 5Mbps,下行速率 10Mbps。它有良好的移动特性,功耗比 NB-IoT 大些,但是低于传统的 2G/3G 设备。所以它适合可穿戴设备、ATM 机、自助售货和无人机等场景。这些场景对数据传输速率有一定要求,但是又不需要达到 4G 的水平.

NB-IoT 的带宽是 180KHz,上行速率 16.9Kbps,下行速率是 26Kbps,功耗很低。所以它不合移动环境,但却很适合智能抄表、智能灯杆和烟感报警器等低数据速率的场景.

### 5G
5G 被分为 3 个主要应用景,分别对应 eMBB、uRLLC 和 mMTC 3 个标准: 
1. eMBB 用于我们日常的手机移动通信,网络传输速率高主要就是指这个标准。 
1. uRLLC 应用的场景是无人驾驶、远程手术等,所以强调的是极低时延,而且是稳定的时延和速率
1. mMTC 可以支持大规模设备的连接上网,适合智能门锁、烟感传感器、路灯等低速率、成本、低功耗的物联网设备

为物联网场景提供新的想象空间的,其实是 uRLLC 和 mMTC.

## 协议
物联网系统必须具备可伸缩性(或者说可扩展性), 设备的增减不会导致系统逻辑的调整. 正是因为这些特点,物联网系统在选择网络通信的协议时,一般采用 发布 - 订阅 的通信模式, 比如[MQTT](/develop/mqtt.md).

特殊场景也可采用`请求 - 响应模式`.

智能家居厂家一般都会制定自己的私有协议,比如小米有Mibeacon 协议. 行业内也有一些标准组织主导的开放协议,比如 [AllJoyn 协议](https://openconnectivity.org/technology/reference-implementation/alljoyn/)

> MiBeacon 协议的广播包定义是基于 BLE 的 GAP(Generic Access Profile)制定的, 主要有广播数据(Advertising Data)和扫描回复数据(Scan Response)两种

### CoAP(Constrained Application Protocol)
类似http, CoAP 协议基于UDP, 适合仅上传不控制, 电池供电的传感器设备.

CoAP 的消息采用二进制格式,支持可确认消息和不可确认消息两种 QoS 级别。可确认消息(Confirmable Message)与 MQTT 协议的 QoS 1 类似,不可确认消息(Non-confirmable Message)对应 MQTT 协议的 QoS 0 级别

### LwM2M
LwM2M 协议定义在 CoAP 协议之上,不过它在消息传输的基础上更进一步。因为它基于 IPSO(IP-base Smart Object)对设备模型进行了标准化,提供了一组轻量级设备管理和交互接口议.

CoAP 协议的应用场景同样适合 LwM2M 协议,如果希望在 CoAP 协议的基础上更方地实现 设备的管理 ,可以考虑 LwM2M 协议.

### Modbus

## 组网
### 零配置组网
1. 自动分配 IP 地址 : DHCP

   
1. 自动发现: 

零配置组网包括三个方面的技术: 
1. 为网络设备自动分配 IP 地址,一般涉及 DHCP 协议和 AutoIP 方法

    > 如果网络内没有 DHCP 服务器 UPnP 会基于自己的 AutoIP 方法指定一个 IP 地址. 在最新的 UPnP 规范中 AutoIP 切换到了 Link-Local Addressing规范

1. 自动发现和解析设备. 在 UPnP 中一般是基于 SSDP 协议,另一种替代方案是 mDNS 协议

    用于 设备和服务发现 的 SSDP(Simple Service Discovery Protocol,简单服务发现协议)协议就是基于 XML 传输数据的. 可以基于 SSDP 中的 M-SEARCH 方法来查询设备,然后基于设备的响应,获得设备服务能力的描述信息; 同时设备可以通过 NOTIFY 方法向网络通知自己的服务能力.

1. 自动传播和发现各网络设备提供的服务. 一种选择是采用 SSDP 协议;另一种案是基于 mDNS 的 DNS-SD 协议

> UPnP 由设备寻址、设备发现、设备描述、设备控制、事件通知和基于 HTML 的描述界面六部构成. 它整合了 DHCP、AutoIP 和 SSDP 等协议规范, 提供了一个完整的组网协议框架. 从整体看,UPnP 是一个 多层协议构成的框架体系. UPnP(Universal Plug and Play)实现网络设备的即插即用. 比较流行的开源库是 libupnp ,小米电视盒子使用的就是它.

零配置组网还可以使用别的协议标准,比如 mDNS 和 DNS-SD 协议. 苹果AirDrop 通过 Bonjour 服务 来发现网络上的其他苹果设备的, 该服务就是 mDNS 协议和 DNS-SD 协议的具体实现.

## 设备
### 物联网网关
物联网网关是设备与云平台之间的桥梁, 常用于协议转换

北向接口 需要接入互联网,所以通常的选择有 RJ45 以太网口、光纤接口、Wi-Fi 和 4G、NB-IoT 等蜂窝网络模组等. 
南向接口 用来连接物联网设备,除了BLE、ZigBee、LoRa、Wi-Fi 这些无线技术的接口, 常见的还有用在工控机 (Industrial Personal Computer,工业控制计算机)上的 RJ45太网口、RS232、RS485 等有线接口.

物联网网关一般还有 设备管理 、 网关配置、 空中升级 这些功能模块.

### 边缘计算
相关技术:
1. 容器技术: KubeEdge
1. 开发框架: EdgeX Foundry
1. 智能家居: HomeEdge

## 隐私
1. 符合法规
2. 实践原则

    1. 保证用户有知情权和选择权
    1. 收集、使用信息时要采用最小必要原则
    1. 保证用户有信息控制自主权
    1. 确保个人信息存储和使用的安全

## 安全
要建立安全管理规范,从机制和组织上保障产品和服务的安全,主要分为四个方面: 
1. 开发: 基于 SDL 来建立企业的安全开发流程,保证开发符合安全规范
1. 生产: 通过质量体系、安全检查等保证出厂产品的合规
1. 部署: 既要注意软件的安全配置,也要保证硬件现场部署的安全措施落地
1. 运营 : 做好监控、运维、应急响应组织建设这三个方面的安全事项

从技术上来保障安全, 具体步骤是先分析安全需求,再构建威模型,然后基于威胁建模的输出,在物联网三层架构中分别做好技术防护措施: 
1. 在设备层中,做好固件、硬件接口上的防护工作
1. 在网络层中,重点关注通信技术、通信协议的风险,保证网络通信采用 SSL/TLS
1. 在应用层中,做好 DDoS 攻击、SQL 注入等安全防护,及时处理安全漏洞

## 计量
### 光
- Lux(勒克斯)是光照强度的单位,是指空间内一个位置接收到的光照强度
- Lumens(流明) 是指一个光源(比如电灯、投影仪)发出的光能力的总量

## FAQ
1. 定向卡与mqtt broker间歇性断开

    1. 检查定向卡的白名单
    1. 咨询sim卡运营商
    1. 换无定向流量卡