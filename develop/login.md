# login设计
参考: [轻松筹1.6亿注册用户的Passport账户体系架构设计](http://www.sohu.com/a/154131834_467759),该方案没有密码登录方式.

## 要求
### 用户体验A
1. 保证只要用户较长时间段（比如 30 天）内登录过，就不需要重新登录 -> expires_in:30d
2. 单点登录，在一个站点登录后，另外一个站点就不需要重复登录（用户几乎无感知）-> oauth 2.0

### 安全性B
1. token 难以伪造，具有一定不可逆性 -> aes
2. token 应该较高的安全性，避免被人获取 token 后伪造用户操作 -> https
3. 被恶意窃取后，具有发现机制 -> ?

### 稳定性C
token 具有自解释性，即自带某些信息，在某些极端恶劣情况下（比如存储服务挂了），依然能提供服务 -> 类似JWT

## 实现原理
用户登录成功后，服务端会生成 token 信息，并将其和用户信息关联起来，返回给前端 token 信息，前端携带 token 来访问所有接口，后端再根据前端发过来的 token 信息标识这是哪个用户的行为.

### token信息
- access_token=base64(aes(uid+create_time+expires_in)), 用户唯一标识, 需要验证登录的所有请求都需要携带(放在http header里),默认30天过期

## 登录方式
各个站点可以根据自己的需要，提前过期，比如说提前一个小时就认为 token 过期了，跳转到 passport 重新获取，这也是用户体验上的考虑.

### 禁用情况
场景: 修改密码, 踢人.

- 将过滤信息写入redis,key(uid)=Set(失效时间,过期时间30天)
- 每个带token请求都过redis,检查token是否已禁用 

### web-app 平台单点登录方案
使用SSO登录.

#### SSO实现 采用 oauth 2.0
单点登录 SSO（Single Sign On）: 只要在一个产品线上（比如站点 A）登录了，在其它产品线上（比如站点 B）就不需要再重新登陆了.

[原理](http://img.mp.sohu.com/upload/20170703/7c149ef140df448a81a0f1e5a8eb1c3b_th.png)

### native-app 平台登录方案
对于所有产品线的 iOS、Android 等平台暂时不考虑单点登录的功能.

## 登录流程

### 手机验证码登录
仅存在于 passport 前端和后端交互.
[流程](http://img.mp.sohu.com/upload/20170703/6ac16c2c5f314631b4ce054086bc96dd_th.png)

注意:
- 为了防止刷短信的问题，增加了图片验证码的校验，但是考虑用户体验，仅仅只是在怀疑对方是恶意操作的时候(即多次发送短信)
- 为了防止短信验证码的暴力破解，做了一些错误次数的校验

### 第三方登录（微信、微博、QQ 等）
[流程](http://img.mp.sohu.com/upload/20170703/40cfb92ded054a07aa334f05c74a4878_th.png)