# 存储

## fsync
确保操作系统缓存内的写数据以及磁盘上缓存的写数据已落盘.

- 落盘写延迟是共识算法、数据库等应用最核心硬盘指标, 其中关键是fsync.
- SATA和NVME的落盘写延迟差异**远小于**掉电保护的有无带来的延迟差异

  有无掉电保护下的缓存恰恰正是上述fsync()性能巨大差异的原因: 在具有掉电保护企业盘里，当fsync()的时候，数据只要成功写入SSD卡上的内存缓存里就可以回复主机报告落盘完成，因为即使系统突然掉电，电容内的电量足够确保维持供电直到缓存内的数据安全落盘写入NAND。而不具备掉电保护的奇葩级企业盘，比如上述Google云的本地NVME盘，以及NVME的Samsung 950 PRO这款家用盘，每次均必须把数据实打实写到NAND存储芯片里才算完成落盘.
- 家用级与企业级的最根本区别在于是否具有掉电保护，以及掉电保护带来的落盘写延迟差异.
- PostgreSQL自带的_pg_test_fsync_是测试fsync的最佳工具, 建议: **延迟200微秒以上的固态盘建议直接调换到不需要WAL的领域, 禁止部署在共识算法、数据库等需要WAL的领域里**

参考:
- [硬盘性能的几大误解 - 从共识算法开谈](https://my.oschina.net/u/4062427/blog/3007382)