# ipv6

## 概念
- PMTU: 传输路径上允许的最大的MTU,即路径上所有链路MTU的最小值.

## 数据包
数据包= 报头(header:40B) + 扩展报头(extension header,可选,没有长度限制) + 上层协议数据单元(upper layer protocol data unit,比如ICMPv6,tcp或udp)

其中,`扩展报头+上层协议数据单元`称为`有效载荷`.

### 报头
![IPv6 Fixed Header](https://7n.w3cschool.cn/attachments/tuploads/ipv6/IPv6_header.jpg)

IPv6固定报头长度为40字节，8个字段,包含以下信息:
1. 版本(version:4b):表示Internet协议的版本，即0110=6
1. 通信流类别(traffic class:8b):这8位分为两部分。 最重要的6位用于服务类型，以便让路由器知道应该向该分组提供什么服务。 最低有效2位用于显式拥塞通知(ECN)
1. 流标签(flow label:20b):此标签用于维护属于通信的数据包的顺序流。 源标记序列以帮助路由器识别特定分组属于特定信息流。 此字段有助于避免数据包的重新排序。 它是为流媒体/实时媒体设计的。
1. 有效负载长度(payload length:16b):该字段用于告诉路由器特定分组在其有效载荷中包含多少信息。使用16位，可以指示高达65535个字节; 但是如果扩展报头包含逐跳扩展报头，则有效载荷可能超过65535字节，并且此字段设置为0。
1. 下一个报头(next head:8b): 定义了紧跟在header后面第一个扩展报头的类型,或者上层协议数据单元中的协议类型.
1. 跳跃限制(hot limit:8b): 定义了数据包所能经过的最大跳数. 这与IPv4中的TTL相同。 跳跃限制字段的值在它通过链路(路由器/跳跃)时递减1。 当字段达到0时，数据包被丢弃。
1. 源地址(source addr:128b): 发起方的地址
1. 目标地址(destination addr:128b):接收方的地址

> 在ipv6中, 中间路由器不再处理分端, 只由发起方处理, 节省了中间路由器的大量资源,比如cpu.
> ipv6没有校验和字段: 第2,4层都有校验和(udp校验和在ipv6中是必需的), 因此第3层校验和是冗余的.
> ipv4有选项字段,因此其报头长度可变;ipv6选项由扩展报头处理,因此长度固定.

### 扩展报头
![RFC 2460定义的必须支持的扩展报头](https://7n.w3cschool.cn/attachments/tuploads/ipv6/extension_headers.jpg)

1. 逐跳扩展头（Hop-by-Hop option）:代码是0。用来携带一些可选信息，数据包所经由的路径上的所有路由器**都必须**处理该可选信息。可选信息的结构包括可选数据类型、可选数据长度和可选数据3部分。RFC2460附录B介绍了如何定义可选数据结构。
1. 目标扩展头（Destination option）：代码是60。用来携带那些仅需要数据包目的地节点处理的可选信息。可选信息的结构包括可选数据类型、可选数据长度和可选数据3部分。
1. 路由扩展头（Routing）：代码是43。用来定义源路由。该扩展报头中的数据部分列出了一系列数据包到达目的地必须经由的节点地址。
1. 分段扩展头（Fragment）：代码是44。当发送方必须对超出MTU的数据进行分段时使用该扩展报头。扩展报头在每一个数据片段中都存在。
1. 认证扩展头（Authentication,AH）：代码时51。封装IPSec数据,定义和 IPv4 中相同
1. 封装安全有效载荷扩展头(Encapsulation Security Payload，ESP): 代码时50, 用于 IPSec，提供报文验证、完整性检查和加密。定义和 IPv4 中相同.

> [IPv4 和 IPv6 报头格式说明](https://ccie.lol/knowledge-base/ipv4-and-ipv6-packet-header/)

扩展报头的顺序:

![扩展报头的顺序](https://7n.w3cschool.cn/attachments/tuploads/ipv6/extension_headers_sequence.jpg)

上图中上标注释:
1. 应由第一个和后续目的地处理。
1. 应由最终目的地处理。

## ICMPv6
ICMPv6包有类型（Type:1B），代码（Code:1B），校验和（Checksum:2B）和消息体（Message Body）等几个字段,分类:
- 差错报文: 报告在转发ipv6数据包过程中出现的错误,比如(序号即为Type):

      1. 目的地不可达: 通知源地址，不能发送数据包
      2. 数据包太大: 通知源地址，数据包太大无法转发
      3. 超时: 通知源地址，IPv6数据包的“跃点限制”已过期
      4. 参数问题: 通知源地址，在处理 IPv6报头或 IPv6扩展报头时发生错误
- 信息报文: 提供诊断功能和附加的主机功能,比如组播侦听发现(MLD)和领节点发现(ND),比如:

      128. 回显请求: 用来确定 IPv6节点在网络上是否可用。
      129. 回显应答: 对“回显请求”的应答。
      133. 路由器请求: 对“路由器请求”的应答。
      134. 路由器公告: 对“路由器公告”的应答。