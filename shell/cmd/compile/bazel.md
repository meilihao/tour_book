# bazel
ref:
- [Bazel学习笔记](https://blog.gmem.cc/bazel-study-note)

bazel是Google公司开源的一个自动化软件构建和测试工具. Bazel使用分布式缓存和增量构建方法，使构建更加快速. 其支持构建任务，包括运行编译器和链接器以生成可执行程序和库.

Bazel与Make、Gradle及Maven等构建工具类似，但Bazel在构建速度、可扩展性、灵活性及跨语言和对不同平台的支持上更加出色。Bazel具有如下特性:
- 支持多语言 ：Bazel支持Java、Objective-C和C++等主流语言，并可以扩展支持任意的其他编程语言
- 高级别的构建语言 ：项目以BUILD语言进行描述。BUILD是一种简洁的文本格式，可描述多个小而互相关联的库、二进制程序和测试程序组成的项目
- 支持多平台 ：相同的工具和BUILD文件可以为不同架构或平台构建软件
- 再现性 ：在BUILD文件中，必须明确为每个库、测试程序、二进制文件指定其直接依赖. 在修改源码文件后，Bazel使用这个依赖信息就可以知道哪些东西必须重新构建，哪些任务可以并行执行. 这意味着所有的构建都是以增量的形式构建的并能够每次都生成相同的结果.
- 可扩展性强 ：Bazel可以处理大型程序的构建

    在Google公司内，一个二进制程序通常有超过100KB的源码文件，在代码文件没有被改动的情况下，构建过程大约需要200ms.
- 构建速度快 ：支持增量编译. 对依赖关系进行了优化，从而支持并发执行.

但是如此优秀的Bazel为什么在开源软件中流行不起来，只能在Google内部大量使用呢？一方面是因为接入Bazel较为复杂；另一方面在于Google内部的代码库非常庞大（约有数百万行），Bazel支持多语言的构建系统为所有项目构建代码，将源码统一存放，使用统一的持续集成来运行所有的单元测试，因此在构建过程中性能问题是最关键的问题，而大部分公司很少遇到像Google这样进行大规模编译的性能问题.

> chrome, android因早于bazel出现而使用了自己的构建方式.

## Bazel的工作原理
源码的根目录下有一个WORKSPACE（工作区）文件，用于指定当前目录是Bazel的一个工作区域，该文件一般存放在项目根目录下. 另外，项目中包含一个或多个BUILD文件，用于告诉Bazel如何进行构建.

Bazel工作原理大致分为3部分:
1. 加载与Target相关的BUILD文件
1. 分析BUILD文件的内容，生成Action Graph
1. 执行Action Graph，最后产出Outputs

以k8s ABAC资源的BUILD文件为例，该文件定义在pkg/apis/abac/v1beta1/BUILD中:
- load ：需要使用哪个.bzl规则来编译当前Target
- go_library ：设置构建规则
- name ：当前Target构建后的名称
- src ：当前Target下被构建的源码文件
- deps ：当前Target构建时依赖的静态库名称