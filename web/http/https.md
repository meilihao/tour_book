## http缺点

HTTP 主要有如下:

- 通信使用明文（不加密），内容可能会被窃听
- 不验证通信方的身份，因此有可能遭遇伪装
- 无法证明报文的完整性，所以有可能已遭篡改

### 通信使用明文可能会被窃听

互联网上的任何角落都存在通信内容被窃听的风险.

抓包工具 Wireshark,它可以获取 HTTP 协议的请求和响应的内容，并对其进行解析.

https对策:通过和 SSL（Secure Socket Layer，安全套接层）或 TLS（Transport Layer Security，安全层传输协议）的组合使用，加密整个通信线路.

### 不验证通信方的身份就可能遭遇伪装

HTTP 协议中的请求和响应不会对通信方进行确认,可能会碰到:

- 无法确定请求发送至目标的 Web 服务器是否是按真实意图返回响应的那台服务器。有可能是已伪装的 Web 服务器。
- 无法确定响应返回到的客户端是否是按真实意图接收响应的那个客户端。有可能是已伪装的客户端。
- 无法确定正在通信的对方是否具备访问权限。因为某些 Web 服务器上保存着重要的信息，只想发给特定用户通信的权限。
- 无法判定请求是来自何方、出自谁手。
- 即使是无意义的请求也会照单全收。无法阻止海量请求下的 DoS 攻击（Denial of Service，拒绝服务攻击）。

典型的是DNS劫持.

https对策:通过使用服务端证书，以证明通信方就是意料中的服务器.另外，客户端持有证书即可完成个人身份的确认，也可用于对 Web 网站的认证环节.

### 无法证明报文完整性，可能已遭篡改

此时可能会碰到:

- 接收到的内容可能有误

典型的是ISP广告注入.

请求或响应在传输途中，遭攻击者拦截并篡改内容的攻击称为**中间人攻击（Man-in-the-Middle attack，MITM）**.

提供文件下载服务的 Web 网站通常会提供相应的以 PGP（Pretty Good Privacy，完美隐私）创建的数字签名及 MD5 算法生成的散列值。PGP 是用来证明创建文件的数字签名，MD5 是由单向函数生成的散列值。不论使用哪一种方法，都需要操纵客户端的用户本人亲自检查验证下载的文件是否就是原来服务器上的文件(前提是PGP 和 MD5 本身是正确的,但其本身可能被改写)。浏览器无法自动帮用户检查。

https对策:提供认证和加密处理及摘要功能.

## https

HTTP+ 加密 + 认证 + 完整性保护 =HTTPS

证书可证明服务器或客户端的身份.

对称加密困境:

- 只要有密钥,任何人都能解密密文.
- 密钥必须发给接受者,发送时有被窃听的风险.且如果密钥能安全发送,那数据也应该能安全送达.

HTTPS 采用对称加密和非对称加密两者并用的混合加密机制.

若要密钥能够实现安全交换，那么有可能会考虑仅使用公开密钥加密来通信,但是非对称加密与对称加密相比，其处理速度要慢.为了发挥各自优势,在交换密钥环节使用非对称加密方式，之后的建立通信交换报文阶段则使用对称加密方式.

https通信过程:

1. 使用非对称加密安全地交换在稍后的对称加密中要使用的密钥.
2. 确保交换的密钥是安全的前提下,使用对称加密方式进行通信.

非对称加密存在的问题:无法证明public key本身是真实的.即客户端无法验证服务器发送的public key是真实的,在传输中可能被攻击者替换.

解决方法是数字证书认证机构（CA，Certificate Authority）和其相关机关颁发的公钥证书(公钥证书=服务提供者的public+服务提供者信息+CA的数字签名).

数字证书认证机构处于客户端与服务器双方都可信赖的第三方机构的立场上.

接到证书的客户端可使用数字证书认证机构的公开密钥，对那张证书上的数字签名进行验证，一旦验证通过，客户端便可明确两件事：一，认证服务器的公开密钥的是真实有效的数字证书认证机构。二，服务器的公开密钥是值得信赖的。

认证机关的公开密钥必须安全地转交给客户端。使用通信方式时，如何安全转交是一件很困难的事，因此，多数浏览器开发商/OS发布版本时，会事先在内部植入常用认证机关的公开密钥.

### SSL协议的握手过程(可参考openssl和nss实现代码)

　　SSL 协议既用到了公钥加密技术又用到了对称加密技术，对称加密技术虽然比公钥加密技术的速度快，可是公钥加密技术提供了更好的身份认证技术。SSL 的握手协议非常有效的让客户和服务器之间完成相互之间的身份认证，其主要过程如下：

　　1. 客户端的浏览器向服务器传送客户端SSL协议的版本号，加密算法的种类，产生的随机数，以及其他服务器和客户端之间通讯所需要的各种信息。

　　2. 服务器向客户端传送SSL协议的版本号，加密算法的种类，随机数以及其他相关信息，同时服务器还将向客户端传送自己的证书。

　　3. 客户利用服务器传过来的信息验证服务器的合法性，服务器的合法性包括：证书是否过期，发行服务器证书的CA 是否可靠，证书发行者的公钥能否正确解开服务器证书的“发行者的数字签名”，服务器证书上的域名是否和服务器的实际域名相匹配。如果合法性验证没有通过，通讯将断开；如果合法性验证通过，将继续进行第四步。

　　4. 客户端产生一个用于后面通讯的随机数(pre-master secret)，然后用服务器的公钥（服务器的公钥从步骤2中的服务器的证书中获得）对其加密，然后传给服务器。

   5. 如果服务器要求客户的身份认证（在握手过程中为可选），用户可以建立一个随机数然后对其进行数据签名，将这个含有签名的随机数和客户自己的证书以及加密过的“预主密码”一起传给服务器。

　　6. 如果服务器要求客户的身份认证，服务器必须检验客户证书和签名随机数的合法性，具体的合法性验证过程包括：客户的证书使用日期是否有效，为客户提供证书的CA 是否可靠，发行CA 的公钥能否正确解开客户证书的发行 CA 的数字签名，检查客户的证书是否在证书废止列表（CRL）中。检验如果没有通过，通讯立刻中断；如果验证通过，服务器将用自己的私钥解开加密的“预主密码 ”，然后执行一系列步骤来产生主通讯密码（客户端也将通过同样的方法产生相同的主通讯密码）。

　　7. 服务器和客户端用上面提到的3个随机数生成key并将其作为服务器和客户端的“通话密码”.同时在SSL 通讯过程中还要完成数据通讯的完整性，防止数据通讯中的任何变化。

　　8. 客户端向服务器端发出信息，指明后面的数据通讯将使用的步骤7中的主密码为对称密钥，同时通知服务器客户端的握手过程结束。

　　9. 服务器向客户端发出信息，指明后面的数据通讯将使用的步骤7中的主密码为对称密钥，同时通知客户端服务器端的握手过程结束。

　　10. SSL 的握手部分结束，SSL 安全通道的数据通讯开始，客户和服务器开始使用相同的对称密钥进行数据通讯，同时进行通讯完整性的检验。


## tools
- [SSL 通配证书](https://www.oschina.net/news/291664/httpsok-1-11-0-released)