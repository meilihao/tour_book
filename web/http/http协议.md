# 简单的http协议

一个http事务由一条(从客户端发往服务器的)请求命令和一个（从服务器发回客户端的）响应结果组成。这种通信是通过名为HTTP报文(http message)的格式化数据进行的.

用于 HTTP 协议交互的信息被称为 HTTP 报文.请求端（客户端）的 HTTP 报文叫做请求报文，响应端（服务器端）的叫做响应报文.HTTP 报文本身是由多行（用 CR+LF 作换行符）数据构成的字符串文本.

HTTP 报文大致可分为报文首部和报文主体两块.两者由最初出现的空行（CR+LF）来划分.通常，并不一定要有报文主体.报文首部是服务器或客户端需处理的请求或响应的内容及属性.报文主体是应被发送的数据.

请求报文是由请求行(请求方法、请求 URI、协议版本)、可选的请求首部字段和内容实体构成的.

响应报文基本上由响应行(协议版本、状态码（表示请求成功或失败的数字代码）、原因短语(用以解释状态码))、可选的响应首部字段以及实体主体构成.

首部字段是指包含表示请求和响应的各种条件和属性的各类首部，一般有 4 种首部，分别是：通用首部、请求首部、响应首部和实体首部。

> 报文主体和实体主体的差异：
>
> 报文（message）
>
> 是 HTTP 通信中的基本单位，通过 HTTP 通信传输。
>
> 实体（entity）
>
> 作为请求或响应的有效载荷数据（补充项）被传输，其内容由实体首部和实体主体组成。
>
> HTTP 报文的主体用于传输请求或响应的实体主体。
>
> 通常，报文主体等于实体主体。只有当传输中进行编码操作时，实体主体的内容发生变化，才导致它和报文主体产生差异。

http是**无状态**协议,但**Cookie技术可保持状态**.

## http方法

```
GET      请求获取Request-URI所标识的资源
POST     在Request-URI所标识的资源后附加新的数据
HEAD     请求获取由Request-URI所标识的资源的响应消息报头(用以确认URI的有效性及资源更新的日期时间和通信状态等)
PUT      请求服务器存储一个资源，并用Request-URI作为其标识(**本身不带验证机制,需自实现**)
DELETE   请求服务器删除Request-URI所标识的资源(同PUT**本身不带验证机制**)
TRACE    请求服务器回送收到的请求信息，主要用于测试或诊断
CONNECT  用隧道协议连接代理
OPTIONS  请求查询服务器的性能，或者查询与资源相关的选项和需求(通常是查询支持的方法)
```
### CONNECT

CONNECT方法要求在与代理服务器通信时建立隧道，实现用隧道协议进行 TCP 通信.主要使用 SSL（Secure Sockets Layer，安全套接层）和 TLS（Transport Layer Security，传输层安全）协议把通信内容加密后经网络隧道传输

CONNECT 方法的格式:`CONNECT 代理服务器名:端口号 HTTP版本`.

### TRACE

追踪路径.

发送请求时，在 Max-Forwards 首部字段中填入数值，每经过一个服务器端就将该数字减 1，当数值刚好减到 0 时，就停止继续传输，最后接收到请求的服务器端则返回状态码 200 OK 的响应.

客户端通过 TRACE 方法可以查询发送出去的请求是怎样被加工修改 / 篡改的。这是因为，请求想要连接到源目标服务器可能会通过代理中转，TRACE 方法就是用来确认连接过程中发生的一系列操作.

但是，TRACE 方法本来就不怎么常用，再加上它容易引发 XST（Cross-Site Tracing，跨站追踪）攻击，通常就更不会用到了.

## 持久连接

HTTP/1.1 默认支持持久连接（HTTP Persistent Connections，也称为 HTTP keep-alive 或 HTTP connection reuse）的方法.持久连接的特点是，只要任意一端没有明确提出断开连接，则保持 TCP 连接状态.

持久连接旨在建立 1 次 TCP 连接后进行多次请求和响应的交互.它的好处在于减少了 TCP 连接的重复建立和断开所造成的额外开销，减轻了服务器端的负载,提升 Web 页面的响应速度.

## 管线化

持久连接使得多数请求以管线化（pipelining）方式发送成为可能.从前发送请求后需等待并收到响应，才能发送下一个请求.管线化后就能够做到同时并行发送多个请求，而传送过程中不需先等待服务端的回应,即不用等待响应亦可直接发送下一个请求.

## Cookie

Cookie 技术通过在请求和响应报文中写入 Cookie 信息来控制客户端的状态.

Cookie 会根据从服务器端发送的响应报文内的一个叫做 Set-Cookie 的首部字段信息，通知客户端保存 Cookie.当下次客户端再往该服务器发送请求时，客户端会自动在请求报文中加入 Cookie 值.

## http编码

用于提升传输速率.

常用的内容编码有以下几种：

gzip（GNU zip）

compress（UNIX 系统的标准压缩）

deflate（zlib）

identity（不进行编码）

## 分割发送的分块传输编码

在 HTTP 通信过程中，请求的编码实体资源尚未全部传输完成之前，浏览器无法显示请求页面.在传输大容量数据时，通过把数据分割成多块，能够让浏览器逐步显示页面.

这种把实体主体分块的功能称为分块传输编码（Chunked Transfer Coding）.

## MIME

MIME（Multipurpose Internet Mail Extensions，多用途因特网邮件扩展）机制，它允许邮件处理文本、图片、视频等多个不同类型的数据.在 MIME 扩展中会使用一种称为多部分对象集合（Multipart）的方法，来容纳多份不同类型的数据,通常在上传时使用.

Multipart包括：

- multipart/form-data

 在 Web 表单文件上传时使用.

 ```
Content-Type: multipart/form-data; boundary=AaB03x // boundary为分隔符
　
--AaB03x // 分隔符前带`--`
Content-Disposition: form-data; name="field1"
　
Joe Blow
--AaB03x
Content-Disposition: form-data; name="pics"; filename="file1.txt"
Content-Type: text/plain
　
...（file1.txt的数据）...
--AaB03x-- // 末尾分隔符后带`--`
```

> 上传文件过程即是将文件编码为multipart/form-data后放到http.body里进行上传.

- multipart/byteranges

 状态码 206（Partial Content，部分内容）响应报文包含了多个范围的内容时使用.类似于 FlashGet 或者迅雷这类的 HTTP 下载工具都是使用此类响应实现断点续传或者将一个大文档分解为多个下载段同时下载.

```
HTTP/1.1 206 Partial Content
Date: Fri, 13 Jul 2012 02:45:26 GMT
Last-Modified: Fri, 31 Aug 2007 02:02:20 GMT
Content-Type: multipart/byteranges; boundary=THIS_STRING_SEPARATES


--THIS_STRING_SEPARATES
Content-Type: application/pdf
Content-Range: bytes 500-999/8000


...（范围指定的数据）...
--THIS_STRING_SEPARATES
Content-Type: application/pdf
Content-Range: bytes 7000-7999/8000


...（范围指定的数据）...
--THIS_STRING_SEPARATES--
```

在 HTTP 报文中使用多部分对象集合时，需要在首部字段里加上 Content-type.

使用 boundary 字符串来划分多部分对象集合指明的各类实体.在 boundary 字符串指定的各个实体的起始行之前插入“--”标记（例如：--AaB03x、--THIS_STRING_SEPARATES），而在多部分对象集合对应的字符串的最后插入“--”标记（例如：--AaB03x--、--THIS_STRING_SEPARATES--）作为结束.

多部分对象集合的每个部分类型中，都可以含有首部字段.另外，可以在某个部分中嵌套使用多部分对象集合.

## 获取部分内容的范围请求

想实现能从之前下载中断处恢复下载,就需要指定下载的实体范围.像这样，指定范围发送的请求叫做范围请求（Range Request）.

```
Get /logo.jpg HTTP/1.1
Host: XXX
Range: bytes =5001-10000
-------------------------
HTTP/1.1 206 Partial Content
Data: XXX
Content-Range: bytes =5001-10000/10000
Content-Length: 5000
Content-Type:image/jpeg
```

针对范围请求，响应会返回状态码为 206 Partial Content 的响应报文．另外，对于多重范围的范围请求，响应会在首部字段 Content-Type 标明 multipart/byteranges 后返回响应报文(见上面MIME中的例子)．

如果服务器端无法响应范围请求，则会返回｀状态码 200 OK｀和｀完整的实体内容｀．

## 内容协商返回最适合的内容

同一个 Web 网站有可能存在着多份相同内容的页面,比如google不同版本的首页.

当浏览器的默认语言为英语或中文，访问相同 URI 的 Web 页面时，则会显示对应的英语版或中文版的 Web 页面.这样的机制称为内容协商（Content Negotiation）.

内容协商机制是指客户端和服务器端就响应的资源内容进行交涉，然后提供给客户端最为适合的资源.内容协商会以响应资源的语言、字符集、编码方式等作为判断的基准.

包含在请求报文中的某些首部字段（如下）就是判断的基准:

- Accept
- Accept-Charset
- Accept-Encoding
- Accept-Language
- Content-Language

内容协商技术有以下 3 种类型:

- 服务器驱动协商（Server-driven Negotiation）

 由服务器端进行内容协商。以请求的首部字段为参考，在服务器端自动处理。但对用户来说，以浏览器发送的信息作为判定的依据，并不一定能筛选出最优内容。

- 客户端驱动协商（Agent-driven Negotiation）

 由客户端进行内容协商的方式。用户从浏览器显示的可选项列表中手动选择。还可以利用 JavaScript 脚本在 Web 页面上自动进行上述选择。比如按 OS 的类型或浏览器类型，自行切换成 PC 版页面或手机版页面。

- 透明协商（Transparent Negotiation）

 是服务器驱动和客户端驱动的结合体，是由服务器端和客户端各自进行内容协商的一种方法.

# 与 HTTP 协作的 Web 服务器

一台 Web 服务器可搭建多个独立域名的 Web 网站，也可作为通信路径上的中转服务器提升传输效率.

## 用单台虚拟主机实现多个域名

HTTP/1.1 规范允许一台 HTTP 服务器搭建多个 Web 站点.提供 Web 托管服务（Web Hosting Service）的供应商通常利用虚拟主机（Virtual Host，又称虚拟服务器）实现该功能.

## 通信数据转发程序 ：代理、网关、隧道

### 代理

代理是一种有转发功能的应用程序，它扮演了位于服务器和客户端“中间人”的角色，接收由客户端发送的请求并转发给服务器，同时也接收服务器返回的响应并转发给客户端.**代理不改变请求 URI**.每次通过代理服务器转发请求或响应时，会追加写入 Via 首部信息以标记出经过的主机信息.

在相同的 IP 地址下，由于虚拟主机可以寄存多个不同主机名和域名的 Web 网站，因此在发送 HTTP 请求时，必须在 **Host 首部内完整指定主机名或域名的 URI**.

通过设置组织内部的代理服务器可做到针对特定URI访问的控制.

使用代理服务器的理由有：利用缓存技术减少网络带宽的流量，组织内部针对特定网站的访问控制，以获取访问日志为主要目的，等等.

代理有多种使用方法，按两种基准分类:一种是是否使用缓存，另一种是是否会修改报文.

#### 缓存代理

缓存是指**代理服务器或客户端**本地磁盘内保存的资源副本.利用缓存可减少对源服务器的访问，因此也就节省了通信流量,通信时间和压力.缓存服务器是代理服务器的一种，并归类在缓存代理类型中.

代理转发响应时，缓存代理（Caching Proxy）会预先将资源的副本（缓存）保存在代理服务器上.当代理再次接收到对相同资源的请求时，就可以不从源服务器那里获取资源，而是将之前缓存的资源作为响应返回.

缓存有时效性.当判定缓存过期后，会向源服务器确认资源的有效性,若判断浏览器缓存失效，浏览器会再次请求新资源.

#### 透明代理

转发请求或响应时，**不对报文做任何加工的代理类型被称为透明代理**（Transparent Proxy）.反之，对报文内容进行加工的代理被称为非透明代理.

### 网关

网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，它就像自己拥有资源的源服务器(持有资源实体的服务器被称为源服务器)一样对请求进行处理。有时客户端可能都不会察觉，自己的通信目标是一个网关.**利用网关可以由 HTTP 请求转化为其他协议通信**.

网关的工作机制和代理十分相似,而网关能使通信线路上的服务器提供非 HTTP 协议服务.

利用网关能提高通信的安全性，因为可以在客户端与网关之间的通信线路上加密以确保连接的安全.

### 隧道

隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序.

隧道协议将其它协议的数据帧或包重新封装然后通过隧道发送(即隧道是一种封装技术，它利用一种网络协议来传输另一种网络协议，即利用一种网络传输协议，将其他协议产生的数据报文封装在它自己的报文中，然后在网络中传输).**HTTP隧道技术就是把所有要传送的数据全部封装到HTTP协议里进行传送**，HTTP隧道技术几乎支持了所有的上网方式，如：拨号上网、ADSL、Cable Modem、NAT透明代理、HTTP的GET型和CONNECT型代理、SOCKS4代理、SOCKS5代理等.

隧道可按要求建立起一条与其他服务器的通信线路，届时使用 TLS/SSL 等加密手段进行通信.隧道的目的是确保客户端能与服务器进行安全的通信.隧道本身不会去解析 HTTP 请求.也就是说，请求保持原样中转给之后的服务器(即隧道本身是透明的，客户端不用在意隧道的存在).隧道会在通信双方断开连接时结束.

## 其他

### Agent代理

Agent代理是代表用户(不一定是人类)发起HTTP请求的客户端程序,通常是指Web浏览器,网络蜘蛛(spider),Web机器人(Web robot).

### 正向代理和反向代理
**正向代理**:一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并**指定目标(原始服务器)**，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。代理服务器一般作用在客户端,被用户感知,例如GoAgent翻墙软件.
**反向代理**:客户端向反向代理的命名空间（name-space）中的内容发送普通请求，接着反向代理将**判断向何处（原始服务器）转交请求**，并将获得的内容返回给客户端。反向代理正好与正向代理相反，**对于客户端而言代理服务器就像是原始服务器**，并且客户端不需要进行任何特别的设置,反向代理服务器作用在服务器端，对外透明不被感知，常见的有Nginx,CDN缓存服务器.

>两者区别
- 用途上：
正向代理的典型用途是**为在防火墙内的局域网客户端提供访问Internet的途径**。正向代理还可以使用缓冲特性减少网络使用率。反向代理的典型用途是**将防火墙后面的服务器提供给用户访问**。反向代理还可以为后端的多台服务器提供负载均衡、或为后端较慢的服务器提供缓冲服务。
另外，反向代理还可以启用高级URL策略和管理技术，从而使处于不同Web服务器系统的web页面同时存在于一个URL空间下。
- 安全性：
正向代理允许客户端通过它访问任意网站并且**隐藏客户端自身**，因此你必须采取安全措施以确保仅为经过授权的客户端提供服务。
反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。







